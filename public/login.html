<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <title>Zephyrus | Login</title>

  <link rel="stylesheet" href="./css/forms.css" />
  <link rel="icon" href="../assets/imgs/Zephyrus_2png.png" />
  <link rel="preconnect" href="https://fonts.gstatic.com" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>

<body>
  <!-- Header -->
  <header class="header">
    <div class="container">
      <div class="logo-titulo">
        <img src="./assets/imgs/Zephyrus_2png.png" alt="">
        <h1 class="titulo">Zephyrus</h1>
      </div>

      <!-- Menu desktop -->
      <ul class="navbar" id="navbar">
        <button class="Btn" onclick="location.href='index.html'">Voltar</button>
      </ul>
    </div>
  </header>

  <main id="login-main">
    <div class="login-container">
      <div class="logo">
        <h1>Login</h1>
      </div>
      <div class="formulario">
        <label for="email_input">Endereço de email</label>
        <input type="email" id="email_input" placeholder="email*" class="ipt_digitar" />
        <div id="output_email"></div>

        <label style="margin-top: 15px;" for="senha_input">Senha</label>
        <div class="senha-container">
          <input type="password" id="senha_input" placeholder="senha*" class="ipt_digitar" />
          <span id="toggleSenha" class="toggle-senha">
            <i style="margin-top: 10px;" class="fa fa-eye"></i>
          </span>
        </div>

        <div id="erro" style="display:none; color:red;">E-mail ou Senha inválido!</div>

        <div class="parte-checkbox">
          <div class="checkbox-grupo">
            <input type="checkbox" id="lembrarCheck" />
            <label for="lembrarCheck">Lembre-se de mim</label>
          </div>
        </div>


        <button onclick="entrar()" class="btn-login">Entrar</button>

        <div id="div_loader" style="width: 100%; display: none; justify-content: center; align-items: center; margin-top: 20px;">
          <div class="loader">
            <div class="bar1"></div>
            <div class="bar2"></div>
            <div class="bar3"></div>
            <div class="bar4"></div>
            <div class="bar5"></div>
            <div class="bar6"></div>
            <div class="bar7"></div>
            <div class="bar8"></div>
            <div class="bar9"></div>
            <div class="bar10"></div>
            <div class="bar11"></div>
            <div class="bar12"></div>
          </div>
        </div>

        <p class="nao-cliente">
          Ainda não é um cliente?
          <span><a href="index.html#contato">Entre em contato</a></span>
        </p>
      </div>
    </div>
  </main>
</body>

</html>


<script>

  const senhaInput = document.getElementById("senha_input");
  const toggleSenha = document.getElementById("toggleSenha");
  const iconeSenha = toggleSenha.querySelector("i");

  toggleSenha.addEventListener("click", () => {
    if (senhaInput.type === "password") {
      senhaInput.type = "text";
      iconeSenha.classList.remove("fa-eye");
      iconeSenha.classList.add("fa-eye-slash");
    } else {
      senhaInput.type = "password";
      iconeSenha.classList.remove("fa-eye-slash");
      iconeSenha.classList.add("fa-eye");
    }
  });

  window.onload = () => {
    const lembrarEmail = localStorage.getItem("email")
    const lembrarSenha = localStorage.getItem("senha")
    if (lembrarEmail && lembrarSenha) {
      email_input.value = lembrarEmail
      senha_input.value = lembrarSenha

      document.getElementById("lembrarCheck").checked = true
    }
  }

  function entrar() {
    const emailVar = email_input.value
    const senhaVar = senha_input.value
    const lembrar = document.getElementById("lembrarCheck").checked
    const loader = document.getElementById("div_loader")

    if (!emailVar || !senhaVar) {
      Swal.fire({
        icon: 'warning',
        title: 'Preencha todos os campos!',
      })
      return false
    }

    if (lembrar) {
      localStorage.setItem("email", emailVar)
      localStorage.setItem("senha", senhaVar)
    } else {
      localStorage.removeItem("email")
      localStorage.removeItem("senha")
    }

    loader.style.display = 'flex' 

    fetch("/usuarios/autenticar", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ emailServer: emailVar, senhaServer: senhaVar })
    })
      .then(resposta => {
        loader.style.display = 'none' // esconder loader assim que a resposta chega

        if (resposta.ok) {
          resposta.json().then(json => {
            let status = json.statusUser
            if (status == "inativo") {
              Swal.fire({
                icon: 'error',
                title: 'Conta inválida!',
              })
              return
            }

            sessionStorage.EMAIL_USUARIO = json.email
            sessionStorage.NOME_USUARIO = json.nome
            sessionStorage.ID_USUARIO = json.id_usuario
            sessionStorage.CARGO_USUARIO = json.perfil
            sessionStorage.HOSPITAL_USUARIO = json.fk_hospital
            sessionStorage.EMPRESA_USUARIO = json.fk_empresa

            // Loader e redirecionamento suave
            loader.style.display = 'flex'
            setTimeout(() => {
              if (json.perfil == "empresa" || json.perfil == "adminEmpresa") {
                window.location = "./dashboard/Empresa/mainPage.html"
              } else if (json.perfil == "hospital" || json.perfil == "adminHospital") {
                window.location = "./dashboard/Hospital/mainPage.html"
              } else {
                Swal.fire({
                  icon: 'error',
                  title: 'Perfil não reconhecido!',
                })
                loader.style.display = 'none'
              }
            }, 1000)
          })
        } else {
          resposta.text().then(texto => {
            Swal.fire({
              icon: 'error',
              title: 'E-mail ou senha inválidos!',
            })
          })
        }
      })
      .catch(erro => {
        loader.style.display = 'none'
        Swal.fire({
          icon: 'error',
          title: 'Erro na conexão!',
          text: erro
        })
      })

    return false
  }

</script>