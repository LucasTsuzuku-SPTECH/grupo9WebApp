<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="./../../css/dashboards.css">
  <link rel="icon" href="/assets/imgs/Zephyrus_2png.png" />
  <title>Dashboard - Contas</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
  <script src="../../js/sessao.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <!-- CSS Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- JS Bootstrap -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</head>

<body onload="puxarDados()">
  <div class="div-pai">

    <!-- Cabeçalho -->
    <header style="position: fixed; z-index: 1000;">
      <div class="header-container">
        <div class="div-hamburguer" onclick="toggleSidebar()">
          <!-- Botão Hamburguer -->
          <a class="navbar-mob">
            <i id="icone" class="fa-solid fa-bars"></i>
          </a>
        </div>
        <h2>DASHBOARD - CONTROLE DE CONTAS</h2>
        <div class="div-pai-perfil">
          <div class="div-linha"></div>
          <div class="div-todo-perfil">
            <div class="div-filho-perfil">
              <img src="../../assets/imgs/profile.png" alt="imagem de perfil" class="img-perfil" />
              <img src="../../assets/imgs/seta-para-baixo-braca.png" alt="ver opções" class="img-seta" />
            </div>
            <div class="div-opcoes">
              <div class="div-opcao-sair">
                <button style="border: none;" onclick="limparSessao()" id="sair"><span>Sair</span></button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </header>
    <br><br><br><br>
    <!-- Sidebar Modal -->
    <div id="sidebarModal" class="sidebar-modal">
      <img src="/assets/imgs/Zephyrus_2png.png" alt="">
      <div class="sidebar-header">
        <span>Menu</span>
        <button onclick="toggleSidebar()" class="btn-fechar">&times;</button>
      </div>
      <nav class="sidebar-nav">
        <a style="text-decoration: none;" href="./mainPage.html">Página principal</a>
        <a href="./balanceamentoVentiladores.html">Balanceamento</a>
        <a style="text-decoration: none;" href="./controleSalas.html">Salas</a>
        <a style="text-decoration: none;" class="pgAtual" href="./contas.html">Contas</a>
        <a style="margin-top: 700px;" href="https://suaempresa.atlassian.net/secure/CreateIssue!default.jspa" target="_blank">Abrir Chamado <i class="fa-solid fa-headset"></i></a>
      </nav>
    </div>

    <div class="conteudo-principal">

      <div class="div-flex">
        <div class="div-block">
          <div class="div-links-contas">
            <button class="btn-adicionar" data-bs-toggle="modal" id="modal_some" style="display:flex;"
              data-bs-target="#modalAdicionarUsuario">
              Adicionar novo usuário
            </button>
          </div>

          <div class="div-procura">
            <div class="div-ipt-procura">
              <label for="">Procure pelo Representante:</label>
              <input type="text" id="ipt_representante" class="ipt_procura"
                oninput="buscarRepresentante(ipt_representante.value)" placeholder="Nome do Representante">
            </div>
            <div class="div-ipt-procura">
              <label for="">Filtrar por atividade:</label>
              <select name="" id="select_atividade" onchange="selecionarAtividade()" class="ipt_procura">
                <option value="Ambos">Ambos</option>
                <option value="ativo">Ativo</option>
                <option value="inativo">Inativo</option>
              </select>
            </div>
          </div>

          <div class="mostrarUsuarios">
            <table>
              <thead>
                <tr class="nomeColuna">
                  <th class="colunaUsuario" style="text-align: center;">Hospital | Empresa</th>
                  <th class="colunaRepresentante" style="text-align: center;">Representante</th>
                  <th class="colunaEmail" style="text-align: center;">E-mail</th>
                  <th class="colunaTipoAcesso" style="text-align: center;">Tipo acesso</th>
                  <th class="colunaStatus" style="text-align: center;">Status</th>
                  <th class="colunaEditar" id="coluna_permissao" style="text-align: center;">Editar</th>
                </tr>
              </thead>
              <tbody id="tbody_usuarios">
              </tbody>
            </table>
          </div>

          <!-- Modal Adicionar Usuário -->
          <div class="modal fade" id="modalAdicionarUsuario" tabindex="-1" aria-labelledby="modalLabelUsuario"
            aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
              <div class="modal-content">

                <div class="modal-header">
                  <h5 class="modal-title" id="modalLabelUsuario">Adicionar Novo Usuário</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
                </div>

                <div class="modal-body">
                  <form id="formAdicionarUsuario">
                    <div class="mb-3">
                      <label for="nomeModal" class="form-label">Nome</label>
                      <input type="text" class="form-control" id="nomeModal" required>
                    </div>
                    <div class="mb-3">
                      <label for="emailModal" class="form-label">E-mail</label>
                      <input type="email" class="form-control" id="emailModal" required>
                    </div>
                    <div class="mb-3">
                      <label for="senhaModal" class="form-label">Senha</label>
                      <input type="password" class="form-control" id="senhaModal" required>
                    </div>
                    <div class="mb-3">
                      <label for="confirmSenhaModal" class="form-label">Confirmar Senha</label>
                      <input type="password" class="form-control" id="confirmSenhaModal" required>
                    </div>
                    <div class="mb-3">
                      <label for="perfilModal" class="form-label">Perfil</label>
                      <select class="form-select" id="perfilModal" required>
                        <option value="" selected disabled>Selecione</option>
                        <option value="funcHosp">Funcionário Hospital</option>
                        <option value="adminHosp">Admin Hospital</option>
                      </select>
                    </div>
                  </form>
                </div>

                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                  <button type="button" class="btn btn-primary" onclick="cadastrarModal()">Adicionar</button>
                </div>

              </div>
            </div>
          </div>

          <!-- Modal Editar Usuário -->
          <div class="modal fade" id="modalEditarUsuario" tabindex="-1" aria-labelledby="modalLabelEditarUsuario"
            aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
              <div class="modal-content">

                <div class="modal-header">
                  <h5 class="modal-title" id="modalLabelEditarUsuario">Editar Usuário</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
                </div>

                <div class="modal-body">
                  <form id="formEditarUsuario">
                    <div class="mb-3">
                      <label for="nomeEditar" class="form-label">Nome</label>
                      <input type="text" class="form-control" id="nomeEditar" required>
                    </div>
                    <div class="mb-3">
                      <label for="emailEditar" class="form-label">E-mail</label>
                      <input type="email" class="form-control" id="emailEditar" required>
                    </div>
                    <div class="mb-3">
                      <label for="perfilEditar" class="form-label">Perfil</label>
                      <select class="form-select" id="perfilEditar" required>
                        <option value="" selected disabled>Selecione</option>
                        <option value="funcHosp">Funcionário Hospital</option>
                        <option value="adminHosp">Admin Hospital</option>
                      </select>
                    </div>
                  </form>
                </div>

                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                  <button type="button" class="btn btn-primary" onclick="editarUsuarioModal()">Salvar</button>
                </div>

              </div>
            </div>
          </div>

</body>

<script>
  // -------------------- VARIÁVEIS GLOBAIS ----------------------
  let usuarios = [];
  let hospitais = [];
  let usuarioSelecionado = null; // id do usuário
  let usuarioEditarId = null;

  if (sessionStorage.CARGO_USUARIO != "adminHosp") {
    document.getElementById("modal_some").style.display = "none";
    document.getElementById("coluna_permissao").style.display = "none";

  }

  // -------------------- FUNÇÕES AUXILIARES ----------------------
  function criarLinhaUsuario(usuario, index) {
    const tr = document.createElement('tr');
    tr.innerHTML = `
    <td class="colunaUsuario">${usuario.nomeHospital ?? "-"}</td>
    <td class="colunaRepresentante">${usuario.nome}</td>
    <td class="colunaEmail">${usuario.email}</td>
    <td class="colunaTipoAcesso">${usuario.cargo}</td>
    <td class="colunaAcesso">
      <button class="btn-status  ${usuario.statusUser === 'ativo' ? 'btn-ativo' : 'btn-inativo'}" id="permissao_alterar"
        onclick="${sessionStorage.CARGO_USUARIO != 'adminHosp' ? '' : `alterarAcesso(${usuario.idUsuario})`} ">
        ${usuario.statusUser.charAt(0).toUpperCase() + usuario.statusUser.slice(1)}
      </button>
    </td>
    ${sessionStorage.CARGO_USUARIO != 'adminHosp' ? '' : `<td class="colunaEditar" style="text-align:center;">
      <button onclick="abrirModalEditar(${usuario.idUsuario})" style="background:transparent;border:none;">
        <img src="../../assets/imgs/editar.png" alt="Editar" style="width:20px;height:20px;">
      </button>
    </td>`}
    
  `;
    tr.style.backgroundColor = index % 2 === 0 ? '#d3d3d3' : '#ffffff';
    return tr;
  }

  function preencherTabela(lista) {
    const tbody = document.getElementById('tbody_usuarios');
    tbody.innerHTML = '';
    for (i of lista) {
      tbody.appendChild(criarLinhaUsuario(i))
    }
  }

  // -------------------- CRUD ----------------------
  async function puxarDados() {
    let idHospital = sessionStorage.getItem("FK")
    try {
      const res = await fetch(`/contas/contasHospital/${idHospital}`);
      if (!res.ok) throw new Error("Erro na resposta da API");
      usuarios = await res.json();
      preencherTabela(usuarios);
    } catch (err) {
      console.error(err);
    }
  }

  async function alterarAcesso(idUsuario) {
    const usuario = usuarios.find(u => u.idUsuario === idUsuario);
    const novoStatus = usuario.statusUser.toLowerCase() === "ativo" ? "inativo" : "ativo";
    try {
      await fetch(`/contas/alterarAcessoHospital/${usuario.idUsuario}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ statusUser: novoStatus })
      });
      usuario.statusUser = novoStatus;
      selecionarAtividade()
    } catch (err) {
      console.error(err);
    }
  }

  // -------------------- FILTROS ----------------------
  function buscarRepresentante(nome) {
    if (!nome) return puxarDados();
    const filtro = usuarios.filter(u =>
      u.nome.replace(/\s/g, "").toLowerCase().includes(nome.replace(/\s/g, "").toLowerCase())
    );
    preencherTabela(filtro);
  }

  function selecionarAtividade() {
    const atividade = document.getElementById('select_atividade').value;
    if (atividade === "Ambos") return puxarDados();
    preencherTabela(usuarios.filter(u => u.statusUser === atividade));
  }

  // -------------------- MODAIS ----------------------

  function abrirModalEditar(id) {
    usuarioEditarId = id;
    const u = usuarios.find(x => x.idUsuario === id);
    document.getElementById("nomeEditar").value = u.nome;
    document.getElementById("emailEditar").value = u.email;
    document.getElementById("perfilEditar").value = u.cargo;
    new bootstrap.Modal(document.getElementById("modalEditarUsuario")).show();
  }

  async function editarUsuarioModal() {
    const nome = document.getElementById("nomeEditar").value;
    const email = document.getElementById("emailEditar").value;
    const perfil = document.getElementById("perfilEditar").value;

    try {
      await fetch(`/contas/editarContaHospital/${usuarioEditarId}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ nome, email, perfil })
      });
      bootstrap.Modal.getInstance(document.getElementById("modalEditarUsuario")).hide();
      puxarDados();
      Swal.fire({ icon: 'success', title: 'Sucesso', text: 'Usuário editado com sucesso!', timer: 2000, showConfirmButton: false });
    } catch (err) {
      console.error(err);
      Swal.fire({ icon: 'error', title: 'Erro', text: 'Não foi possível editar o usuário!' });
    }
  }


  // -------------------- CADASTRO ----------------------
  async function cadastrarModal() {
    const nome = document.getElementById("nomeModal").value;
    const email = document.getElementById("emailModal").value;
    const senha = document.getElementById("senhaModal").value;
    const confirmar = document.getElementById("confirmSenhaModal").value;
    const perfil = document.getElementById('perfilModal').value;
    if (senha !== confirmar) {
      Swal.fire({ icon: 'error', title: 'Erro', text: 'As senhas não coincidem!' });
      return;
    }
    let fkHospital = sessionStorage.getItem('FK')
    try {
      await fetch("/contas/cadastrarFuncHospital", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          nomeServer: nome,
          emailServer: email,
          senhaServer: senha,
          perfilServer: perfil,
          fkHospital: fkHospital,
        })
      });
      Swal.fire({ icon: 'success', title: 'Sucesso', text: 'Usuário cadastrado com sucesso!', timer: 2000, showConfirmButton: false });
      document.getElementById("formAdicionarUsuario").reset();
      bootstrap.Modal.getInstance(document.getElementById("modalAdicionarUsuario")).hide();
      puxarDados();
    } catch (err) {
      console.error(err);
      Swal.fire({ icon: 'error', title: 'Erro', text: 'Não foi possível cadastrar o usuário!' });
    }
  }

  // -------------------- SIDEBAR ----------------------
  function toggleSidebar() {
    document.getElementById("sidebarModal").classList.toggle("active");
  }

  // -------------------- ONLOAD ----------------------
  window.onload = puxarDados;
</script>