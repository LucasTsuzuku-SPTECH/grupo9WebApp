<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="./../../css/dashboards.css">
  <link rel="icon" href="/assets/imgs/Zephyrus_2png.png" />
  <title>Dashboard - Contas</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
  <script src="../../js/sessao.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</head>
<style>
  .corPrincipal {
    background: #264653;
  }
</style>

<body onload="puxarDados()">
  <div class="div-pai">

    <!-- Cabeçalho -->
    <nav class="navbar corPrincipal fixed-top py-3">
      <div class="container-fluid justify-content-start">
        <button class="navbar-toggler" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasNavbar"
          aria-controls="offcanvasNavbar" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="containerTitulo">
          <div class="logo-titulo">
            <img src="/assets/imgs/Zephyrus_2png.png" style="width: 50px;" alt="">
            <h1 class="titulo">Zephyrus</h1>
          </div>
        </div>
      </div>
    </nav>

    <!-- Menu Offcanvas -->
    <div class="offcanvas offcanvas-start corPrincipal" tabindex="-1" id="offcanvasNavbar"
      aria-labelledby="offcanvasNavbarLabel">
      <img src="/assets/imgs/Zephyrus_2png.png"
        style="width: 136px; align-self: center; margin-bottom: 8px; margin-top: 16px;" alt="">
      <div class="offcanvas-header" style="border-bottom:2px solid rgba(255, 255, 255, 0.5);">
        <h4 class="offcanvas-title" style="color: #f5f6fa;" id="offcanvasNavbarLabel">Menu</h4>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas" aria-label="Close"></button>
      </div>
      <div class="offcanvas-body d-flex flex-column">
        <ul class="navbar-nav justify-content-start flex-grow-1 pe-3">
          <li class="nav-item" style="width: 100%;">
            <a class="nav-link active" style="padding: 4px; color: #f5f6fa; font-size: 18px;"
              href="./mainPage.html">Página principal</a>
          </li>
          <li class="nav-item" style="width: 100%;">
            <a class="nav-link active" style="padding: 4px; color: #f5f6fa; font-size: 18px;"
              href="./balanceamentoVentiladores.html">Balanceamento</a>
          </li>
          <li class="nav-item" style="width: 100%;">
            <a class="nav-link active" style="padding: 4px; color: #f5f6fa; font-size: 18px;"
              href="./controleSalas.html">Salas</a>
          </li>
          <li class="nav-item-selected" style="width: 100%;">
            <a class="nav-link active" style="padding: 4px; color: #f5f6fa; font-size: 18px;"
              href="./contas.html">Contas</a>
        </ul>
        <ul class="navbar-nav d-flex flex-column pe-1">
          <li class="nav-item mt-auto d-flex justify-content-center" style="width: 100%;">
            <a class="btn-suporte" href="/index">
              <img style="width: 40px;" src="/assets/imgs/headphoneIcon.png" alt="">
              Abrir chamado
            </a>
          </li>
          <li class="nav-item d-flex justify-content-center" style="width: 100%;">
            <a class="btn-sair" href="/index.html" onclick="sessionStorage.clear()">
              <img class="icon" src="https://cdn-icons-png.flaticon.com/512/1828/1828479.png" alt="Logout">
              Sair
            </a>
          </li>
        </ul>
      </div>
    </div>

    <br><br><br><br>
    <div class="conteudo-principal">
      <div class="div-flex">
        <div class="div-block">
          <div class="div-links-contas">
            <button class="btn-adicionar" data-bs-toggle="modal" id="modal_some" style="display:flex;"
              data-bs-target="#modalAdicionarUsuario">
              Adicionar novo usuário
            </button>
          </div>

          <div class="div-procura">
            <div class="div-ipt-procura">
              <label for="">Procure pelo Representante:</label>
              <input type="text" id="ipt_representante" class="ipt_procura"
                oninput="buscarRepresentante(ipt_representante.value)" placeholder="Nome do Representante">
            </div>
            <div class="div-ipt-procura">
              <label for="">Filtrar por atividade:</label>
              <select name="" id="select_atividade" onchange="selecionarAtividade()" class="ipt_procura">
                <option value="Ambos">Ambos</option>
                <option value="ativo">Ativo</option>
                <option value="inativo">Inativo</option>
              </select>
            </div>
          </div>

          <div class="mostrarUsuarios">
            <table>
              <thead>
                <tr class="nomeColuna">
                  <th class="colunaUsuario" style="text-align: center;">Hospital | Empresa</th>
                  <th class="colunaRepresentante" style="text-align: center;">Representante</th>
                  <th class="colunaEmail" style="text-align: center;">E-mail</th>
                  <th class="colunaTipoAcesso" style="text-align: center;">Tipo acesso</th>
                  <th class="colunaStatus" style="text-align: center;">Status</th>
                  <th class="colunaEditar" id="coluna_permissao" style="text-align: center;">Editar</th>
                </tr>
              </thead>
              <tbody id="tbody_usuarios">
              </tbody>
            </table>
          </div>

          <!-- Modal Adicionar Usuário -->
          <div class="modal fade" id="modalAdicionarUsuario" tabindex="-1" aria-labelledby="modalLabelUsuario"
            aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
              <div class="modal-content">

                <div class="modal-header">
                  <h5 class="modal-title" id="modalLabelUsuario">Adicionar Novo Usuário</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
                </div>

                <div class="modal-body">
                  <form id="formAdicionarUsuario">
                    <div class="mb-3">
                      <label for="nomeModal" class="form-label">Nome</label>
                      <input type="text" class="form-control" id="nomeModal" required>
                    </div>
                    <div class="mb-3">
                      <label for="emailModal" class="form-label">E-mail</label>
                      <input type="email" class="form-control" id="emailModal" required>
                    </div>
                    <div class="mb-3">
                      <label for="senhaModal" class="form-label">Senha</label>
                      <input type="password" class="form-control" id="senhaModal" required>
                    </div>
                    <div class="mb-3">
                      <label for="confirmSenhaModal" class="form-label">Confirmar Senha</label>
                      <input type="password" class="form-control" id="confirmSenhaModal" required>
                    </div>
                    <div class="mb-3">
                      <label for="perfilModal" class="form-label">Perfil</label>
                      <select class="form-select" id="perfilModal" required>
                        <option value="" selected disabled>Selecione</option>
                        <option value="funcHosp">Funcionário Hospital</option>
                        <option value="adminHosp">Admin Hospital</option>
                      </select>
                    </div>
                  </form>
                </div>

                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                  <button type="button" class="btn btn-primary" onclick="cadastrarModal()">Adicionar</button>
                </div>

              </div>
            </div>
          </div>

          <!-- Modal Editar Usuário -->
          <div class="modal fade" id="modalEditarUsuario" tabindex="-1" aria-labelledby="modalLabelEditarUsuario"
            aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
              <div class="modal-content">

                <div class="modal-header">
                  <h5 class="modal-title" id="modalLabelEditarUsuario">Editar Usuário</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
                </div>

                <div class="modal-body">
                  <form id="formEditarUsuario">
                    <div class="mb-3">
                      <label for="nomeEditar" class="form-label">Nome</label>
                      <input type="text" class="form-control" id="nomeEditar" required>
                    </div>
                    <div class="mb-3">
                      <label for="emailEditar" class="form-label">E-mail</label>
                      <input type="email" class="form-control" id="emailEditar" required>
                    </div>
                    <div class="mb-3">
                      <label for="perfilEditar" class="form-label">Perfil</label>
                      <select class="form-select" id="perfilEditar" required>
                        <option value="" selected disabled>Selecione</option>
                        <option value="funcHosp">Funcionário Hospital</option>
                        <option value="adminHosp">Admin Hospital</option>
                      </select>
                    </div>
                  </form>
                </div>

                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                  <button type="button" class="btn btn-primary" onclick="editarUsuarioModal()">Salvar</button>
                </div>

              </div>
            </div>
          </div>

</body>

</html>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
  integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
<script>
  // -------------------- VARIÁVEIS GLOBAIS ----------------------
  let usuarios = [];
  let hospitais = [];
  let usuarioSelecionado = null; // id do usuário
  let usuarioEditarId = null;

  if (sessionStorage.CARGO_USUARIO != "adminHosp") {
    document.getElementById("modal_some").style.display = "none";
    document.getElementById("coluna_permissao").style.display = "none";

  }

  // -------------------- FUNÇÕES AUXILIARES ----------------------
  function criarLinhaUsuario(usuario, index) {
    const tr = document.createElement('tr');
    tr.innerHTML = `
    <td class="colunaUsuario">${usuario.nomeHospital ?? "-"}</td>
    <td class="colunaRepresentante">${usuario.nome}</td>
    <td class="colunaEmail">${usuario.email}</td>
    <td class="colunaTipoAcesso">${usuario.cargo}</td>
    <td class="colunaAcesso">
      <button class="btn-status  ${usuario.statusUser === 'ativo' ? 'btn-ativo' : 'btn-inativo'}" id="permissao_alterar"
        onclick="${sessionStorage.CARGO_USUARIO != 'adminHosp' ? '' : `alterarAcesso(${usuario.idUsuario})`} ">
        ${usuario.statusUser.charAt(0).toUpperCase() + usuario.statusUser.slice(1)}
      </button>
    </td>
    ${sessionStorage.CARGO_USUARIO != 'adminHosp' ? '' : `<td class="colunaEditar" style="text-align:center;">
      <button onclick="abrirModalEditar(${usuario.idUsuario})" style="background:transparent;border:none;">
        <img src="../../assets/imgs/editar.png" alt="Editar" style="width:20px;height:20px;">
      </button>
    </td>`}
    
  `;
    tr.style.backgroundColor = index % 2 === 0 ? '#d3d3d3' : '#ffffff';
    return tr;
  }

  function preencherTabela(lista) {
    const tbody = document.getElementById('tbody_usuarios');
    tbody.innerHTML = '';
    for (i of lista) {
      tbody.appendChild(criarLinhaUsuario(i))
    }
  }

  // -------------------- CRUD ----------------------
  async function puxarDados() {
    let idHospital = sessionStorage.getItem("FK")
    try {
      const res = await fetch(`/contas/contasHospital/${idHospital}`);
      if (!res.ok) throw new Error("Erro na resposta da API");
      usuarios = await res.json();
      preencherTabela(usuarios);
    } catch (err) {
      console.error(err);
    }
  }

  async function alterarAcesso(idUsuario) {
    const usuario = usuarios.find(u => u.idUsuario === idUsuario);
    const novoStatus = usuario.statusUser.toLowerCase() === "ativo" ? "inativo" : "ativo";
    try {
      await fetch(`/contas/alterarAcessoHospital/${usuario.idUsuario}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ statusUser: novoStatus })
      });
      usuario.statusUser = novoStatus;
      selecionarAtividade()
    } catch (err) {
      console.error(err);
    }
  }

  // -------------------- FILTROS ----------------------
  function buscarRepresentante(nome) {
    if (!nome) return puxarDados();
    const filtro = usuarios.filter(u =>
      u.nome.replace(/\s/g, "").toLowerCase().includes(nome.replace(/\s/g, "").toLowerCase())
    );
    preencherTabela(filtro);
  }

  function selecionarAtividade() {
    const atividade = document.getElementById('select_atividade').value;
    if (atividade === "Ambos") return puxarDados();
    preencherTabela(usuarios.filter(u => u.statusUser === atividade));
  }

  // -------------------- MODAIS ----------------------

  function abrirModalEditar(id) {
    usuarioEditarId = id;
    const u = usuarios.find(x => x.idUsuario === id);
    document.getElementById("nomeEditar").value = u.nome;
    document.getElementById("emailEditar").value = u.email;
    document.getElementById("perfilEditar").value = u.cargo;
    new bootstrap.Modal(document.getElementById("modalEditarUsuario")).show();
  }

  async function editarUsuarioModal() {
    const nome = document.getElementById("nomeEditar").value;
    const email = document.getElementById("emailEditar").value;
    const perfil = document.getElementById("perfilEditar").value;

    try {
      await fetch(`/contas/editarContaHospital/${usuarioEditarId}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ nome, email, perfil })
      });
      bootstrap.Modal.getInstance(document.getElementById("modalEditarUsuario")).hide();
      puxarDados();
      Swal.fire({ icon: 'success', title: 'Sucesso', text: 'Usuário editado com sucesso!', timer: 2000, showConfirmButton: false });
    } catch (err) {
      console.error(err);
      Swal.fire({ icon: 'error', title: 'Erro', text: 'Não foi possível editar o usuário!' });
    }
  }


  // -------------------- CADASTRO ----------------------
  async function cadastrarModal() {
    const nome = document.getElementById("nomeModal").value;
    const email = document.getElementById("emailModal").value;
    const senha = document.getElementById("senhaModal").value;
    const confirmar = document.getElementById("confirmSenhaModal").value;
    const perfil = document.getElementById('perfilModal').value;
    if (senha !== confirmar) {
      Swal.fire({ icon: 'error', title: 'Erro', text: 'As senhas não coincidem!' });
      return;
    }
    let fkHospital = sessionStorage.getItem('FK')
    try {
      await fetch("/contas/cadastrarFuncHospital", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          nomeServer: nome,
          emailServer: email,
          senhaServer: senha,
          perfilServer: perfil,
          fkHospital: fkHospital,
        })
      });
      Swal.fire({ icon: 'success', title: 'Sucesso', text: 'Usuário cadastrado com sucesso!', timer: 2000, showConfirmButton: false });
      document.getElementById("formAdicionarUsuario").reset();
      bootstrap.Modal.getInstance(document.getElementById("modalAdicionarUsuario")).hide();
      puxarDados();
    } catch (err) {
      console.error(err);
      Swal.fire({ icon: 'error', title: 'Erro', text: 'Não foi possível cadastrar o usuário!' });
    }
  }

  // -------------------- SIDEBAR ----------------------
  function toggleSidebar() {
    document.getElementById("sidebarModal").classList.toggle("active");
  }

  // -------------------- ONLOAD ----------------------
  window.onload = puxarDados;
</script>