<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Página Principal</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://kit.fontawesome.com/9f7414eb10.js" crossorigin="anonymous"></script>
    <script src="../../js/sessao.js"></script>
    <link rel="stylesheet" href="./../../css/dashboards.css">
    <link rel="icon" href="../assets/imgs/Zephyrus_2png.png" />
</head>

<body>
    <div class="div-pai">

        <!-- Cabeçalho -->
        <header>
            <div class="header-container">
                <div class="div-hamburguer">
                    <!-- Botão Hamburguer -->
                    <a class="navbar-mob" onclick="toggleSidebar()">
                        <i id="icone" class="fa-solid fa-bars fa-2x"></i>
                    </a>
                </div>
                <h2>DASHBOARD - CONTROLE DE HOSPITAIS</h2>
                <div class="div-pai-perfil">
                    <div class="div-linha"></div>
                    <div class="div-todo-perfil">
                        <div class="div-filho-perfil">
                            <img src="../../assets/imgs/profile.png" alt="imagem de perfil" class="img-perfil" />
                            <img src="../../assets/imgs/seta-para-baixo-braca.png" alt="ver opções" class="img-seta" />
                        </div>
                        <div class="div-opcoes">
                            <div class="div-opcao-sair">
                                <button style="border: none;" onclick="limparSessao()"
                                    id="sair"><span>Sair</span></button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Sidebar Modal -->
        <div id="sidebarModal" class="sidebar-modal">
            <div class="sidebar-header">
                <span>Menu</span>
                <button onclick="toggleSidebar()" class="btn-fechar">&times;</button>
            </div>
            <nav class="sidebar-nav">
                <a href="./mainPage.html">Página principal</a>
                <a href="./controleHospitais.html">Hospitais</a>
                <a href="./contas.html">Contas</a>
            </nav>
        </div>

        <!-- Seção de filtro e KPI -->
        <div style="display: flex; justify-content: space-between; align-items: center; padding: 20px;">

            <!-- KPIs de hospitais -->
            <div class="kpi">
                <!-- Select de Filtro -->
                <select id="filtroCriticidade">
                    <option value="critico">Crítico</option>
                    <option value="alerta">Alerta</option>
                    <option value="estavel">Estável</option>
                </select>
                <div class="item" style=" background-color: rgb(183, 228, 199); border: 2px solid var(--verde-3);">
                    <p>Quantidade Hospitais:</p>
                    <h3 id="qtde_total">0</h3>
                </div>
                <div class="item" style="background-color: rgba(255, 0, 0, 0.2); border: 2px solid red;">
                    <p>Quantidade Hospitais Críticos:</p>
                    <h3 id="qtde_critico">0</h3>
                </div>
                <div class="item" style="background-color: rgba(255, 255, 0, 0.2); border: 2px solid rgb(255, 255, 0);">
                    <p>Quantidade Hospitais Alertas:</p>
                    <h3 id="qtde_alerta">0</h3>
                </div>
                <div class="item" style="background-color: rgba(0, 185, 0, 0.2); border: 2px solid rgb(0, 207, 0);">
                    <p>Quantidade Hospitais Estáveis:</p>
                    <h3 id="qtde_estavel">0</h3>
                </div>
            </div>
        </div>

        <!-- Conteúdo principal -->

        <div class="conteudo-principal"></div>

        <!-- Modal básico -->
        <div id="modalVentiladores" style="display:none;">
            <div id="conteudoVentiladores"></div>
        </div>

        <!-- Modal Adicionar Ventilador -->
        <div id="addVentiladorModal" class="modal-overlay" style="display:none;">
            <div class="modal-content">
                <h3>Adicionar Ventilador <button class="btn-fechar-modal" onclick="fecharAddModal()">X</button></h3>
                <form id="formAddVentilador">
                    <div class="form-group">
                        <label for="numeroSerie">Nº Série</label>
                        <input type="text" id="numeroSerie" required>
                    </div>
                    <div class="form-group">
                        <label for="selectModelo">Modelo</label>
                        <select id="selectModelo" required></select>
                    </div>
                    <input type="hidden" id="fkHospital">
                    <input type="hidden" id="fkEmpresa">
                    <button type="submit" class="btn-submit">Adicionar</button>
                </form>
            </div>
        </div>

    </div>
    </div>
</body>

</html>

<!-- SweetAlert2 -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
    function toggleSidebar() {
        const sidebar = document.getElementById("sidebarModal");
        const icone = document.getElementById("icone");
        sidebar.classList.toggle("active");
    }

    function mostrarNavbar() {
        const larguraTela = window.innerWidth;
        var menu = document.getElementById("navbar");
        var icone = document.getElementById("icone");

        if (larguraTela < 1342) {
            if (getComputedStyle(menu).display == "none") {
                menu.style.display = "flex";
                icone.classList.remove("fa-bars");
                icone.classList.add("fa-times");
            } else {
                menu.style.display = "none";
                icone.classList.remove("fa-times");
                icone.classList.add("fa-bars");
            }
        }
    }

    function Sair() {
        const sair = document.getElementById("sair");

        if (sair) {
            localStorage.removeItem("email");
            localStorage.removeItem("senha");

            sessionStorage.clear();
            console.log(sessionStorage);

            window.location.href = "../../index.html";
        }
    }

    window.onload = () => {
        carregarHospitais().then(() => {
            filtrarHospitais(); // filtra logo após carregar
        });

        document
            .getElementById("filtroCriticidade")
            .addEventListener("change", filtrarHospitais);
    };

    async function carregarHospitais() {
        try {
            const resposta = await fetch("/controle/hospitais");
            const hospitais = await resposta.json();
            const container = document.querySelector(".conteudo-principal");
            container.innerHTML = "";

            let total = hospitais.length;
            let estavel = 0,
                alerta = 0,
                critico = 0;

            hospitais.forEach((hospital) => {
                const statusOpcoes = ["estavel", "alerta", "critico"];
                const statusClass =
                    statusOpcoes[Math.floor(Math.random() * statusOpcoes.length)];

                if (statusClass === "estavel") estavel++;
                if (statusClass === "alerta") alerta++;
                if (statusClass === "critico") critico++;

                const divHospital = document.createElement("div");
                divHospital.classList.add("card-hospital");
                divHospital.setAttribute("data-status", statusClass);

                const nome = document.createElement("h3");
                nome.innerText = hospital.nomeHospital;

                const status = document.createElement("span");
                status.innerText = statusClass;
                status.classList.add("status", statusClass);

                divHospital.appendChild(nome);
                divHospital.appendChild(status);

                // ⬅️ evento de clique já aqui dentro
                divHospital.addEventListener("click", () => {
                    abrirModalVentiladores(hospital.id_hospital);
                });

                container.appendChild(divHospital);
            });

            document.getElementById("qtde_total").innerText = total;
            document.getElementById("qtde_estavel").innerText = estavel;
            document.getElementById("qtde_alerta").innerText = alerta;
            document.getElementById("qtde_critico").innerText = critico;
        } catch (erro) {
            console.error("Erro:", erro);
        }
    }

    function filtrarHospitais() {
        const filtro = document.getElementById("filtroCriticidade").value;
        const hospitais = document.querySelectorAll(".card-hospital");

        hospitais.forEach((hospital) => {
            if (hospital.getAttribute("data-status") === filtro || filtro === "") {
                hospital.style.display = "flex"; // deixa o CSS original aplicar
            } else {
                hospital.style.display = "none";
            }
        });
    }

    function abrirModalVentiladores(idHospital) {
        fetch(`/controle/hospitais/${idHospital}/ventiladores`)
            .then(resp => {
                if (!resp.ok) throw new Error("Erro ao buscar ventiladores");
                return resp.json();
            })
            .then(ventiladores => {
                const conteudo = document.getElementById("conteudoVentiladores");
                conteudo.innerHTML = `
                <h3>
                    ${ventiladores[0]?.nome_hospital || "Hospital"}
                    <button class="btn-fechar-modal" onclick="fecharModal()">X</button>
                </h3>
            `;

                ventiladores.forEach(v => {
                    const divVent = document.createElement("div");
                    divVent.classList.add("ventilador");

                    divVent.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <!-- Nº Série à esquerda -->
                        <div style="display: flex; gap: 5px; align-items: center;">
                            <strong>Nº Série:</strong>
                            <span>${v.numero_serie}</span>
                        </div>

                        <!-- Botões à direita -->
                        <div style="display: flex; gap: 10px;">
                            <button class="button" type="button" data-bs-toggle="modal" data-bs-target="#addMaquinaModal"  onclick="abrirAddModal(${idHospital})">
                                <span class="button_text">Adicionar</span>
                                <span class="button_icon">+</span>
                            </button>
                            <button class="btn-edit" onclick='abrirModalEdicao(${JSON.stringify(v)})'>
                                <span class="btn-text">Editar</span>
                                <i class="fa-regular fa-pen-to-square"></i>
                            </button>
                            <button class="btn-delete" onclick='confirmarDelete(${v.id_ventilador})'>
                                <span class="text">Excluir</span>
                                <i class="fa-solid fa-trash icon"></i>
                            </button>
                        </div>
                    </div>

                    <div class="linha-separadora"></div>

                    <strong>Modelo:</strong> ${v.nome_modelo}<br>
                    <em>${v.descricao_modelo}</em>
                `;

                    conteudo.appendChild(divVent);
                });

                document.getElementById("modalVentiladores").style.display = "flex";
            })
            .catch(err => console.error(err));
    }

    function confirmarDelete(idVentilador) {
        Swal.fire({
            title: 'Tem certeza?',
            text: "Você não poderá reverter isso!",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Sim, deletar!',
            cancelButtonText: 'Cancelar'
        }).then((result) => {
            if (result.isConfirmed) {
                fetch(`/controle/ventiladores/${idVentilador}`, {
                    method: 'DELETE'
                })
                    .then(resp => {
                        if (!resp.ok) throw new Error("Erro ao deletar ventilador");
                        return resp.json();
                    })
                    .then(data => {
                        Swal.fire(
                            'Deletado!',
                            data.message,
                            'success'
                        );
                        // Remove o card do ventilador do modal
                        const card = document.querySelector(`.ventilador button[onclick='confirmarDelete(${idVentilador})']`).closest('.ventilador');
                        if (card) card.remove();
                    })
                    .catch(err => {
                        Swal.fire(
                            'Erro!',
                            'Não foi possível deletar o ventilador.',
                            'error'
                        );
                        console.error(err);
                    });
            }
        })
    }

    // Função para fechar modal
    function fecharModal() {
        document.getElementById("modalVentiladores").style.display = "none";
    }

    window.addEventListener("click", function (event) {
        const modal = document.getElementById("modalVentiladores");
        if (event.target == modal) {
            modal.style.display = "none";
        }
    });

    function abrirAddModal(idHospital) {
        // Preenche fkHospital e fkEmpresa
        document.getElementById("fkHospital").value = idHospital;
        document.getElementById("fkEmpresa").value = sessionStorage.getItem("EMPRESA_USUARIO");

        // Preenche o select de modelos
        fetch('/controle/modelos')
            .then(resp => resp.json())
            .then(modelos => {
                const select = document.getElementById("selectModelo");
                select.innerHTML = '';
                modelos.forEach(m => {
                    const option = document.createElement("option");
                    option.value = m.id_modelo;
                    option.textContent = m.nome;
                    select.appendChild(option);
                });
            });

        document.getElementById("addVentiladorModal").style.display = "flex";
    }

    function fecharAddModal() {
        document.getElementById("addVentiladorModal").style.display = "none";
    }

    document.getElementById("formAddVentilador").addEventListener("submit", function (e) {
        e.preventDefault();

        const novoVentilador = {
            numero_serie: document.getElementById("numeroSerie").value,
            fk_modelo: document.getElementById("selectModelo").value,
            fk_hospital: document.getElementById("fkHospital").value,
            fk_empresa: document.getElementById("fkEmpresa").value
        };

        fetch('/controle/ventiladores', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(novoVentilador)
        })
            .then(resp => {
                if (!resp.ok) throw new Error("Erro ao adicionar ventilador");
                return resp.json();
            })
            .then(data => {
                Swal.fire('Sucesso!', 'Ventilador adicionado.', 'success');
                fecharAddModal();
                abrirModalVentiladores(novoVentilador.fk_hospital); // Recarrega a lista
            })
            .catch(err => {
                Swal.fire('Erro!', 'Não foi possível adicionar o ventilador.', 'error');
                console.error(err);
            });
    });

</script>