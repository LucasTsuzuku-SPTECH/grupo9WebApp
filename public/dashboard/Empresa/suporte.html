<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8">
  <title>Dashboard de Suporte</title>

  <!-- CSS Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- JS Bootstrap -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <style>
    .tooltip-inner {
  max-width: 240px !important;
  text-align: left;
  font-size: 14px;
  padding: 10px 12px;
}
.link{
  text-decoration: none;
  color: inherit;
}
.info-icon {
  width: 17px;
  margin-left: 6px;
  cursor: pointer;
  filter: invert(40%);
}
.buscarChamados {
      background-color: #30a799;
      color: #fff;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
      margin-bottom: 20px;
    }
    body {
      background: #f5f6fa;
      padding-top: 100px;
    }

    .card-kpi {
      text-align: center;
      padding: 20px;
      height: 350px!important;

    }

    .card-kpi h3 {
      font-size: 2rem;
    }

    .corPrincipal {
      background: #264653;
    }

    .navbar-toggler-icon {
      filter: invert(1);

    }

    .numeros {
      display: flex;
      flex-direction: row;
      justify-content: center;
      align-items: flex-start;
      gap: 20px;

    }

    .numero {
      display: flex;
      flex-direction: column;
      align-items: center;
      width: 25%;
      border-radius: 5px;
    }

    .numero p {
      color: #f5f6fa;
      font-size: 20px;
      margin: 0px;
      padding: 5px;
    }

    .kpi-row {
      display: flex;
      gap: 20px;
    }

    .card-kpi {
      flex: 1;
      /* faz todas terem o mesmo tamanho */
      height: 100%;
      /* para crescer igual */
      min-height: 260px;
      /* defina a altura padrão */
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      /* garante alinhamento bonito */
    }

    .containerTitulo .logo-titulo {
      display: flex;
      align-items: center;
      /* Alinha o logo e título verticalmente */
      gap: 10px;
      flex-direction: row;
      /* Distância entre logo e título */
    }
 


    .titulo {
      font-size: 28px;
      font-weight: 600;
      color: white;
      letter-spacing: 1px;
      margin: 0;
      /* Remover qualquer margem extra */
    }


    .containerTitulo {
      display: flex;
      align-items: start;
      margin-left: 20px;

    }
  </style>


  <style>
    .corPrincipal {
      background: #264653;
    }

    .navbar-toggler-icon {
      filter: invert(1);

    }

    .containerTitulo .logo-titulo {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-direction: row;
    }


    .titulo {
      font-size: 28px;
      font-weight: 600;
      color: white;
      letter-spacing: 1px;
      margin: 0;
    }
    .link_tabela{
      text-decoration: none;
      color: inherit;
      
    }


    .containerTitulo {
      display: flex;
      align-items: start;
      margin-left: 20px;

    }

    .nav-item a:hover {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 4px;
    }

    .nav-item-selected {
      background: #30a799;
      border-radius: 4px;

    }

    .nav-item-selected a:hover {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 4px;

    }

    #offcanvasNavbar {
      width: 16%;
    }

    /* Botão de Sair */
    .btn-sair {
      display: flex;
      align-items: center;
      gap: 10px;
      background-color: #e63946;
      color: #fff !important;
      font-size: 20px;
      font-weight: bold;
      padding: 10px;
      border-radius: 6px;
      width: 90%;
      align-self: center;
      justify-content: center;
      transition: 0.2s;
      text-decoration: none;
    }

    .btn-sair:hover {
      background-color: #c92f3e;
    }

    /* Abrir chamado */
    .btn-suporte {
      display: flex;
      align-items: center;
      gap: 10px;
      color: #f5f6fa !important;
      font-size: 20px;
      padding: 8px 10px;
      justify-content: center;
      text-decoration: none;
      margin-bottom: 12px;
    }

    .icon {
      width: 22px;
      height: 22px;
      filter: invert(1);
    }
    .table-container-modern {
  padding: 20px;
  background: rgba(255,255,255,0.65);
  backdrop-filter: blur(8px);
  border-radius: 16px;
  box-shadow: 0 8px 20px rgba(0,0,0,0.1);
}

.table-modern {
  width: 100%;
  border-collapse: collapse;
  border-radius: 12px;
  overflow: hidden;
  font-size: 15px;
}

.table-modern thead {
  background: #264653;
  color: #fff;
}

.table-modern th {
  padding: 14px;
  font-weight: 600;
  letter-spacing: 0.5px;
}

.table-modern td {
  padding: 14px;
  background: #fff;
  transition: background 0.25s;
}

.table-modern tbody tr:hover td {
  background: #f3f7fa;
}

/* Badge de prioridade */
.prio-alta {
  background: #e53935;
  color: #fff;
  padding: 6px 10px;
  border-radius: 10px;
  font-size: 13px;
}
.prio-media {
  background: #fbc02d;
  color: #fff;
  padding: 6px 10px;
  border-radius: 10px;
  font-size: 13px;

}
.prio-baixa {
  background: #43a047;
  color: #fff;
  padding: 6px 10px;
  border-radius: 10px;
  font-size: 13px;
}

.sla-negativo {
  background: #e53935!important;
  color: #fff !important;
  padding: 6px 10px;
  font-size: 13px;
  font-weight: bold;
}

.sla-alerta {
 background: #fbc02d !important;
  color: #fff !important;
  padding: 6px 10px;
  font-size: 13px;
}

.link_tabela {
  text-decoration: none;
  color: #264653;
  font-weight: 600;
}
.link_tabela:hover {
  text-decoration: underline;
}
.table-modern {
  width: 100%;
  border-collapse: separate;
  border-spacing: 0 8px;
  font-size: 0.95rem;
}

.table-modern thead th {
  background: #f8f9fa;
  padding: 12px;
  font-weight: 600;
  color: #333;
  border: none;
}

.table-modern tbody tr {
  background: white;
  box-shadow: 0 2px 6px rgba(0,0,0,0.05);
  border-radius: 12px;
}

.table-modern tbody td {
  padding: 12px 14px;
  border-top: none !important;
}

.badge-status {
  padding: 6px 12px;
  border-radius: 20px;
  font-weight: 600;
  color: white;
  font-size: 0.8rem;
}

.status-normal  { background: #43a047; }
.status-atencao { background: #fbc02d; }
.status-critico { background: #e53935; }

.kpi-good   { color: #43a047 !important; font-weight: bold; }
.kpi-warn   { color: #fbc02d !important; font-weight: bold; }
.kpi-bad    { color: #e53935 !important; font-weight: bold; }

.trend-up { color: #43a047 !important; font-weight: 600; }
.trend-warn { color: #fbc02d !important; font-weight: 600; }
.trend-bad { color: #e53935 !important; font-weight: 600; }


  </style>
</head>



<body>
  <!-- Cabeçalho -->
  <nav class="navbar corPrincipal fixed-top py-3">
    <div class="container-fluid justify-content-start ">
      <button class="navbar-toggler" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasNavbar"
        aria-controls="offcanvasNavbar" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon text-white"></span>
      </button>
      <div class="containerTitulo">
        <div class="logo-titulo">
          <img src="/Web-Site_Zephyrus/public/assets/imgs/Zephyrus_2png.png" style="width: 50px;" alt="">
          <h1 class="titulo">Zephyrus</h1>
        </div>

        <div class="offcanvas offcanvas-start corPrincipal" tabindex="-1" id="offcanvasNavbar"
          aria-labelledby="offcanvasNavbarLabel">
          <img src="/Web-Site_Zephyrus/public/assets/imgs/Zephyrus_2png.png"
            style="width: 170px; align-self: center; margin-bottom: 10px; margin-top: 20px;" alt="">
          <div class="offcanvas-header" style="border-bottom:2px solid rgba(255, 255, 255, 0.5);">
            <h4 class="offcanvas-title " style="color: #f5f6fa; " id="offcanvasNavbarLabel">Menu</h4>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas"
              aria-label="Close"></button>
          </div>
          <div class="offcanvas-body d-flex flex-column">
            <ul class="navbar-nav justify-content-start flex-grow-1 pe-3">
              <li class="nav-item-selected" style="width: 100%;">
                <a id="navMain" class="nav-link active" style="padding: 5px; color: #f5f6fa; font-size: 22px;"
                  href="./mainPage.html">Página
                  principal</a>
              </li>
             
            </ul>
            <ul class="navbar-nav d-flex flex-column flex-grow-1 pe-3">
            
              <li class="nav-item d-flex justify-content-center" style="width: 100%;">
                <a class="btn-sair" href="/index.html" onclick="sessionStorage.clear()">
                  <img class="icon" src="https://cdn-icons-png.flaticon.com/512/1828/1828479.png" alt="Logout">
                  Sair
                </a>
              </li>
            </ul>
          </div>
        </div>
      </div>
  </nav>

  <div class="offcanvas offcanvas-start bg-dark text-white" tabindex="-1" id="sidebarOffcanvas"
    aria-labelledby="sidebarOffcanvasLabel">
    <div class="offcanvas-header justify-content-center">
      <img src="/Web-Site_Zephyrus/public/assets/imgs/Zephyrus_2png.png" alt="Logo" style="height: 40px;">
      <button type="button" class="btn-close text-reset btn-close-white" data-bs-dismiss="offcanvas"
        aria-label="Close"></button>
    </div>
    <div class="offcanvas-body d-flex flex-column">
      <h5 class="offcanvas-title mb-3" id="sidebarOffcanvasLabel">Menu</h5>
      <nav class="nav flex-column flex-grow-1">
        <a class="nav-link text-white active bg-primary" href="./mainPage.html">Página principal</a>

      </nav>
      <div class="mt-auto pt-3 border-top">

      </div>
    </div>
  </div>

  <br><br>
  <div class="container-fluid px-5">
    <h1>Dashboard Suporte</h1>
    <h6 id="ultimaAtualizacao"></h6>
    <button class="buscarChamados" onclick="processarTodosOsAlertas()
">Gerar chamados</button>
    <!-- KPIs -->
    <div class="row kpi-row">

      <div class="col-md-3 card-kpi">
        <div class="card shadow-sm card-kpi">
<h5>
  Cumprimento da SLA
  <img src="https://cdn-icons-png.flaticon.com/512/1828/1828859.png"
       class="info-icon"
       data-bs-toggle="tooltip"
       data-bs-html="true"
       title="
       <b>SLA</b>:Chamados concluidos no prazo/Chamados concluidos<br>
       <b>Verde:</b> ≥ 90% dentro da SLA<br>
       <b>Amarelo:</b> entre 75% e 89%<br>
       <b>Vermelho:</b> abaixo de 75%<br>
       
       ">
</h5>
          <div class="kpiSLACharts" id="kpiSLAChart"></div>
                    <small>Meta: 90%</small>
                                                  <small>Concluidos no prazo/Concluidos</small>


          <small >Em tempo real</small>
          





        </div>
      </div>
      <div class="col-md-3 card-kpi">
        <div class="card shadow-sm card-kpi">
<h5>
  Tempo de resolução médio
  <img src="https://cdn-icons-png.flaticon.com/512/1828/1828859.png"
       class="info-icon"
       data-bs-toggle="tooltip"
       data-bs-html="true"
       title="
       <b>Verde:</b> Menos que 1 dia<br>
       <b>Amarelo:</b> Entre 1 e 2 Dias<br>
       <b>Vermelho:</b> A partir de 2 Dias

       ">
</h5>
          <div id="kpiTempo"></div>
                    <small>Meta:1 Dia</small>


          <small>Últimos 7 dias</small>
        </div>
      </div>

      <div class="col-md-3 card-kpi">
        <div class="card shadow-sm card-kpi">
<h5>
  Chamados Abertos
  <img src="https://cdn-icons-png.flaticon.com/512/1828/1828859.png"
       class="info-icon"
       data-bs-toggle="tooltip"
       data-bs-html="true"
       title="
       <b>Verde:</b> Variação de até 10% do limite<br>
       <b>Amarelo:</b> Variação entre 10% e 20% do limite<br>
       <b>Vermelho:</b> Variação acima de 20% do limite
       ">
</h5>
          <div id="chartChamadosAberto"></div>

          <h3 id="kpiAbertos"></h3>
          <h5>Prioridade dos chamados</h5>
          <div class="row d-flex justify-content-between gap-2 mt-2">

            <div class="col p-1 text-center text-white rounded" style="background-color:#e53935;height: 50px!important;">
              <p class="m-0 fw-bold">Alta</p>
              <p class="m-0" id="kpiAlta">-</p>
            </div>

            <div class="col p-1 text-center text-white rounded" style="background-color:#fbc02d;height: 50px!important;">
              <p class="m-0 fw-bold">Média</p>
              <p class="m-0" id="kpiMedia">-</p>
            </div>

            <div class="col p-1 text-center text-white rounded" style="background-color:#43a047; height: 50px!important;">
              <p class="m-0 fw-bold">Baixa</p>
              <p class="m-0" id="kpiBaixa">-</p>
            </div>

          </div>
                      <div class="col p-2 text-center text-white rounded" style="background-color:#6b6b6b; margin-top: 10px; max-height: 30px;">
              <p class="m-0 fw-bold " id="kpiNaoAtribuidos" style="padding: bottom 5px!important;">
            </div>
          



          <small>Em tempo real</small>
        </div>
      </div>

      <div class="col-md-3 card-kpi">
        <div class="card shadow-sm card-kpi">
<h5>
  Chamados resolvidos
  <img src="https://cdn-icons-png.flaticon.com/512/1828/1828859.png"
       class="info-icon"
       data-bs-toggle="tooltip"
       data-bs-html="true"
       title="
              <b>Resolução</b>:Chamados concluidos/Chamados totais<br>

       <b>Verde:</b> ≥ 80% resolvidos<br>
       <b>Amarelo:</b> 60–79%<br>
       <b>Vermelho:</b> abaixo de 60%
       ">
</h5>
          <div class="kpiResolvidosCharts" id="kpiResolvidosChart"></div>
                              <small>Meta: 80%</small>
                              <small>Chamados concluidos/Total de chamados</small>

          <small>Em tempo real</small>





        </div>
      </div>
    </div>
    <div class="row mt-4">
      <div class="col-md-12">
        <div class="card shadow-sm p-3" style="max-height: 300px; overflow-y: auto;">
          <h5 class="mb-3">Chamados que Ameaçam a SLA</h5>

          <div class="table-responsive">
            <table class="table table-striped table-hover align-middle">
              <thead style="background-color: #264653;">
                <tr>
                  <th>ID</th>
                  <th>Título</th>
                  <th>Criação</th>
                  <th>Prioridade</th>
                  <th>Responsável</th>
                  <th>Tempo Restante</th>
                  <th>Hospital</th>
                  <th>Area</th>
                </tr>
              </thead>
              <tbody id="tabelaSLA">
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
    <div class="row mt-4">
  <div class="col-md-12">
    <div class="card shadow-sm p-3">
      <h5 class="mb-3">Backlog ao longo do tempo (Burndown)</h5>
      <div id="burndown" style="height: 320px;"></div>
    <small style="margin: auto;">Meta: Backlog com no máximo 70 chamados</small>

    </div>
  </div>
</div>

        <div class="row mt-4">
      <div class="col-md-12">
        <div class="card shadow-sm p-3" style="max-height: 500px; overflow-y: auto;margin-bottom: 50px;">
          <h5 class="mb-3">Painel de produtividade</h5>
   
          <div class="table-responsive">
            <table class="table table-striped table-hover align-middle">
              <thead style="background-color: #264653;">
    <thead>
      <tr>
        <th>Técnico</th>
        <th>Status</th>
        <th>SLA</th>
        <th>Tempo Médio</th>
        <th>Total</th>
        <th>Taxa Resolução</th>
        <th>Workload</th>
      </tr>
    </thead>
    <tbody id="tabelaProdutividade"></tbody>
  </table>
</div>



</body>

</html>






<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>


<!-- ApexCharts -->
<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
<script>
  let chamadosCache = null
  window.onload = async () => {

    chamadosCache = await buscarChamados();
    await plotarGraficoTempo();
    exibirPrioridade();
    exibirChamadosSLA()
    plotarGraficoResolucao();
        plotarGraficoSLA();
preencherTabelaProdutividade()
    processarProdutividade(),
    gerarBurndown(),
    plotarBurndown()

  };
  const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]');
  const tooltipList = [...tooltipTriggerList].map(
    el => new bootstrap.Tooltip(el)
  )
   

  function processarProdutividade(){
    const chamados=chamadosCache

    const produtividade={}
    chamados.forEach(chamado=>{
      const responsavel=chamado.responsavel?? "Sem responsável"
      if(!produtividade[responsavel]){
        produtividade[responsavel]={
          totalChamados:0,
          totalResolvidos:0,
          resolvidosNoPrazo:0,
          somaTemposResolucao:0,
        totalTempos: 0

        }
      }



    const tempoResolucao = calularTempoDeResolucao(chamado)

    produtividade[responsavel].totalChamados++;
    if(chamado.data_conclusao!=null){
    produtividade[responsavel].totalResolvidos++

    }
    produtividade[responsavel].somaTemposResolucao += tempoResolucao;
    produtividade[responsavel].totalTempos++;
      const resolvido=new Date(chamado.data_conclusao)
    const slaLimite = chamado.data_limite;
    if (slaLimite) {
      const dataLimite = new Date(slaLimite);
      if (resolvido <= dataLimite) {
        produtividade[responsavel].resolvidosNoPrazo++;
      }
    }



    })
  const resultado = []

  Object.keys(produtividade).forEach(pessoa => {
    const p = produtividade[pessoa];

    const tempoMedio = p.totalTempos > 0
      ? Math.floor(p.somaTemposResolucao / p.totalTempos)
      : 0;

    const taxaCumprimento = p.totalChamados > 0
      ? ((p.resolvidosNoPrazo / p.totalChamados) * 100).toFixed(1)
      : "0";
      

    resultado.push({
      pessoa,
      tempoMedio,
      taxaCumprimento,
      totalResolvidos:p.totalResolvidos,
      totalChamados: p.totalChamados
    });
  });
console.log(resultado)
  return resultado;

  }
  function exibirPrioridade() {
    const chamados = chamadosCache
    let abertos = 0
    let alta = 0
    let media = 0
    let baixa = 0
    let naoAtribuidos=0
    chamados.forEach(chamado => {
      if (chamado.data_conclusao == null) {
        abertos++
        if (chamado.prioridade == "Baixa") {
          baixa++
        }
        else if (chamado.prioridade == "Media") {
          media++
        }
        else if (chamado.prioridade == "Alta") {
          alta++
        }
      }
      if(!chamado.responsavel){
        naoAtribuidos++
      }
    })
    document.getElementById("kpiAbertos").innerText = abertos
    document.getElementById("kpiAlta").innerText = alta;
    document.getElementById("kpiMedia").innerText = media;
    document.getElementById("kpiBaixa").innerText = baixa;
    document.getElementById("kpiNaoAtribuidos").innerHTML = `<p>Chamados não atribuidos: ${naoAtribuidos}<a  class="link" href="https://zephyrus2g1.atlassian.net/jira/software/projects/KAN/list?sortBy=customfield_10091&direction=ASC&filter=status%20%3D%20%22To%20Do%22%20AND%20assignee%20%3D%20empty" target="_blank">↗️</a>
</p>`




  }
function preencherTabelaProdutividade() {
  const tabela = document.getElementById("tabelaProdutividade");
  const produtividade=processarProdutividade()
  tabela.innerHTML = "";
const chamados=chamadosCache
chamadosAbertos=chamados.filter(c=>c.data_conclusao==null).length


  Object.keys(produtividade).forEach(agente => {
    const p = produtividade[agente];
    console.log(p)
    if(p.pessoa=="Sem responsável") return;
    const emProgresso=p.totalChamados-p.totalResolvidos
    const taxaResolucao=p.totalResolvidos/p.totalChamados 
    const workload = (emProgresso / chamadosAbertos) * 100
    console.log(p)
    console.log(taxaResolucao)

    const status =
      p.taxaCumprimento >= 90 ? "Normal" :
      p.taxaCumprimento >= 75 ? "Atenção" : "Crítico";

    const statusClass =
      p.taxaCumprimento>= 90 ? "status-normal" :
      p.taxaCumprimento >= 75 ? "status-atencao" : "status-critico";

    const tr = document.createElement("tr");

    tr.innerHTML = `
      <td>
        <strong>${p.pessoa ?? "-"}</strong><br>
      </td>

      <td>
        <span class="badge-status ${statusClass}">${status}</span>
      </td>

      <td class="kpi-${statusClass}">
        ${p.taxaCumprimento}%
      </td>

      <td class="${p.tempoMedio <= 1440? "kpi-good" :
                  p.tempoMedio <= 2880 ? "kpi-warn" : "kpi-bad"}">
        ${formatarTempo(p.tempoMedio)}
      </td>

      <td>${p.totalChamados}</td>



      <td class="${taxaResolucao >= 0.90 ? "kpi-good" :
                  taxaResolucao >= 0.75 ? "kpi-warn" : "kpi-bad"}">
        ${  Math.round(taxaResolucao* 100,1)}%
      </td>
      <td>${workload.toFixed(1)}%</td>
      <td></td>
    `;

    tabela.appendChild(tr);
  });
}


  function exibirChamadosSLA() {

  const chamados = chamadosCache;
  chamados.sort((a, b) => new Date(a.data_limite) - new Date(b.data_limite))

  const tabela = document.getElementById("tabelaSLA");
  tabela.innerHTML = "";

  chamados.forEach(chamado => {

    if (!chamado.data_limite) return;
    if(chamado.data_conclusao!=null) return

    const hoje = new Date();
    const dataLimite = new Date(chamado.data_limite);
    const tempoRestante = dataLimite - hoje;

    const minutos = Math.floor(tempoRestante / 60000);
    const tempoFormatado = formatarTempo(minutos);

    let classeSLA = "";
    if (minutos < 0) classeSLA = "sla-negativo";
    else if (minutos <= 2880) classeSLA = "sla-alerta";

    const prioridade = chamado.prioridade?.toLowerCase() ?? "-";
    let classePrio = "";
    if (prioridade.includes("alta")) classePrio = "prio-alta";
    else if (prioridade.includes("média") || prioridade.includes("media")) classePrio = "prio-media";
    else classePrio = "prio-baixa";

    const tr = document.createElement("tr");

    tr.innerHTML = `
      <td><a class="link_tabela" href="${chamado.link}">${chamado.id}↗</a></td>
      <td>${chamado.titulo}</td>
      <td>${new Date(chamado.data_criacao).toLocaleDateString()}</td>
      <td><span class="${classePrio}">${chamado.prioridade}</span></td>
      <td>${chamado.responsavel ?? "-"}</td>
      <td class="${classeSLA}">${tempoFormatado}</td>
      <td>${chamado.hospital ?? "-"}</td>
      <td>${chamado.area ?? "-"}</td>
    `;

    tabela.appendChild(tr);
  });
}

  // ================================
  // KPI - Radial % Resolvidos
  function calcularPercentual() {
    const chamados = chamadosCache
    let resolvidos = 0
    let total = chamados.length
    chamados.forEach(chamado => {
      if (chamado.data_conclusao != null) {
        resolvidos++
      }

    })
    return resolvidos / total * 100
  }

  // ================================
  function plotarGraficoResolucao() {
    const valor = Math.round(calcularPercentual(), 1)

    function corPorPercentual(p) {
      if (p <= 75) return '#e53935';  
      if (p < 90) return '#fbc02d';  
      return '#43a047';              
    }

    var optionsResolvidos = {
      series: [valor],
      chart: {
        height: 185,
        type: 'radialBar',
      },
      plotOptions: {
        radialBar: {
          startAngle: -90,
          endAngle: 90,
          hollow: {
            size: '70%'
          },
          track: {
            background: '#eee',
            strokeWidth: '100%'
          },
          dataLabels: {
            name: {
              show: false,
              text: 'Resolvidos',
              offsetY: 20,
              fontSize: '16px'
            },
            value: {
              show: true,
              offsetY: -20,
              fontSize: '28px',
              fontWeight: 600,
              formatter: () => valor + "%"
            },
            
          },
        }

      },
      fill: {
        colors: [corPorPercentual(valor)]
      },
      stroke: {
        lineCap: 'round'
      }

    };

    var chartResolvidos = new ApexCharts(document.querySelector("#kpiResolvidosChart"), optionsResolvidos);
    chartResolvidos.render();
  }
 function calcularPercentualSLA() {
    const chamados = chamadosCache 

    const chamadosConcluidos = chamados.filter(chamado => {
        const resolvido = new Date(chamado.data_conclusao)
        const dataLimite = new Date(chamado.data_limite)
        return !isNaN(resolvido) && !isNaN(dataLimite)
    })

    const totalConcluidos = chamadosConcluidos.length

    if (totalConcluidos === 0) {
        console.warn("Nenhum chamado concluído (com datas válidas) para calcular.");
        return 0
    }

    let noPrazo = 0
    chamadosConcluidos.forEach(chamado => {
        const resolvido = new Date(chamado.data_conclusao)
        const dataLimite = new Date(chamado.data_limite)

        if (resolvido <= dataLimite) {
            noPrazo++
        }
    })

    console.log(`Chamados no Prazo: ${noPrazo}, Total Concluído Válido: ${totalConcluidos}`)
    return (noPrazo / totalConcluidos) * 100
}
function plotarGraficoSLA() {
    const valor = Math.round(calcularPercentualSLA(), 1); 
    function corPorPercentual(p) {
      if (p <= 75) return '#e53935';  
      if (p <90) return '#fbc02d';  
      return '#43a047';               
    }

    var optionsResolvidos = {
      series: [valor],
      chart: {
        height: 185,
        type: 'radialBar',
      },
      plotOptions: {
        radialBar: {
          startAngle: -90,
          endAngle: 90,
          hollow: {
            size: '70%'
          },
          track: {
            background: '#eee',
            strokeWidth: '100%'
          },
          dataLabels: {
            name: {
              show: false,
              text: 'Resolvidos',
              offsetY: 20,
              fontSize: '16px'
            },
            value: {
              show: true,
              offsetY: -20,
              fontSize: '28px',
              fontWeight: 600,
              formatter: () => valor + "%"
            }
          }
        }

      },
      fill: {
        colors: [corPorPercentual(valor)]
      },
      stroke: {
        lineCap: 'round'
      }

    };

    var chartResolvidos = new ApexCharts(document.querySelector("#kpiSLAChart"), optionsResolvidos);
    chartResolvidos.render();
  }

  //GRAFICO DA KPI DE TEMPO

  function plotarGraficoTempo() {
    const { mediaFormatada, tempos,media } = processarTempoMedioDeResolucao();

    let cor=""
    if(media<=1440){
      cor="#43a047"
    }
    else if(media>1440 && mediaFormatada<=2880){
      cor="#fbc02d"
    }
    else{
      cor="#e53935"
    }
    console.log(tempos)
    var graficoTempoOptions = {
      series: [{ data: tempos, name: "Tempo de resolução (min) " }],
      chart: {
        type: 'area',
        height: 144,
        sparkline: { enabled: true },
      },
      stroke: { curve: 'straight' },
      fill: { opacity: 0.3 },
      yaxis: { min: 0 },
      colors: [cor],
      title: {
        text: mediaFormatada,
        offsetX: 0,
        style: { fontSize: '24px' }
      }
    };

    var chartTempo = new ApexCharts(
      document.querySelector("#kpiTempo"),
      graficoTempoOptions
    );

    chartTempo.render();
  }//AQUI COMECA O CALCULO DO TEMPO MEDIO DOS CHAMADOS 
  //PRIMEIRO A FUNÇÃO QUE CALCULA O TEMPO MEDIO DE UM CHAMADO
  function calularTempoDeResolucao(chamado) {
    if (!chamado.data_criacao || !chamado.data_conclusao) return null;
    if (chamado.data_criacao === chamado.data_conclusao) return null;

    const criacao = new Date(chamado.data_criacao);
    const conclusao = new Date(chamado.data_conclusao);

    const diferencaMS = conclusao - criacao;
    const totalMin = Math.floor(diferencaMS / (1000 * 60));

    return totalMin;
  }

  //AGORA CALCULAR A MEDIA DE TEMPO DOS CHAMADOS, ENTÃO ELE RECEBE UM VETOR DE CHAMADOS
  function calularTempoMedioDeResolucao(chamados) {
    let soma = 0;
    let qtd = 0;
    let tempos = [];

    chamados.forEach(chamado => {
      const minutos = calularTempoDeResolucao(chamado);

      if (minutos !== null) {
        tempos.push(minutos)
        soma += minutos
        qtd++
      }
    })

    if (qtd === 0) return { media: 0, tempos }

    let media = Math.floor(soma / qtd)
    tempos = tempos.reverse()
    return { media, tempos }
  }

  //Formatar de minutos para dias horas e min
  function formatarTempo(totalMin) {
    if (totalMin === null || totalMin === undefined) return "N/A";

    const dias = Math.floor(totalMin / 1440);
    const horas = Math.floor((totalMin % 1440) / 60);
    const minutos = totalMin % 60;

    let txt = "";
    if (dias > 0) txt += `${dias} dia${dias > 1 ? "s" : ""} `;
    if (horas > 0) txt += `${horas}h `;
    txt += `${minutos}min`;

    return txt.trim();
  }

  //CHAMAR TODAS AS FUNCOES
  //CHAMAR TODAS AS FUNCOES (filtrar apenas últimos 7 dias)
  function processarTempoMedioDeResolucao() {
    if (!chamadosCache || chamadosCache.length === 0)
      return { mediaFormatada: "N/A", tempos: [] };

    const hoje = new Date();
    const seteDiasAtras = new Date(hoje);
    seteDiasAtras.setDate(hoje.getDate() - 7);

    const chamadosUltimos7Dias = [];

    chamadosCache.forEach(chamado => {
      if (!chamado?.data_criacao) return;

      const criacao = new Date(chamado.data_criacao);

      if (!isNaN(criacao) && criacao >= seteDiasAtras && criacao <= hoje) {
        chamadosUltimos7Dias.push(chamado);
      }
    });

    if (chamadosUltimos7Dias.length === 0)
      return { mediaFormatada: "N/A", tempos: [] };

    const { media, tempos } = calularTempoMedioDeResolucao(chamadosUltimos7Dias);
    const mediaFormatada = formatarTempo(media);

    return { mediaFormatada, tempos ,media};
  }





  



</script>
<script src="../js/chart.js"></script>
<script>



  async function buscarChamados(params) {

    try {
      const resposta = await fetch("/jira/buscarChamadosJira")
      const data = await resposta.json();
      const ultimaAtualizacao = new Date(). toLocaleString('pt-BR', {
        timeZone: 'America/Sao_Paulo',
        hour12: false
      });
      document.getElementById("ultimaAtualizacao").innerText = `Ultima Atualização: ${ultimaAtualizacao}`;
      console.log(data)
      const chamados = []
      data.issues.forEach(chamado => {
        const campo = chamado.fields
        let responsavel_= ""
        if(campo.assignee!=null){
        responsavel_=  campo.assignee.displayName
        }
        else{
          responsavel_=campo.assignee
        }
        let prioridade=""
        if(campo.priority.name=="High"){
          prioridade="Alta"
        }
        else if(campo.priority.name=="Medium"){
          prioridade="Media"
        }
        else if(campo.priority.name=="Low"){
          prioridade="Baixa"
        }
         let key= chamado.key
        chamados.push({
          id: chamado.id,
          titulo: campo.summary,
          prioridade: prioridade,
          data_criacao: campo.created,
          data_conclusao: campo.resolutiondate,
          hospital: campo.customfield_10091,
          area: campo.customfield_10092,
          responsavel: responsavel_,
          status: campo.status.name,
          data_limite: campo.duedate,
          link:`https://zephyrus2g1.atlassian.net/jira/software/projects/KAN/list?direction=ASC&selectedIssue=${key}&sortBy=labels`


        })

      });
      console.log(chamados)
      return chamados

    } catch (error) {
      console.log(error)

    }

  }
  
async function buscarAlertasDuplicadosJira(numeroSerie, componente) {
  try {
    const resposta = await fetch(`/jira/verificar/${numeroSerie}/${componente}`);
    const data = await resposta.json();
    console.log(data)
    return data
    
  } catch (e) {
      }
}function gerarBurndown() {

  const chamado = chamadosCache
console.log(chamadosCache)
  const criadosPorDia = {};
  const resolvidosPorDia = {};

  chamado.forEach(chamado => {

    const dCriado = new Date (chamado.data_criacao).toLocaleDateString();
    if (!criadosPorDia[dCriado]) {
      criadosPorDia[dCriado] = 0;
    }
    criadosPorDia[dCriado]++;
    console.log(dCriado)

    const resolvido =chamado.data_conclusao;
    if (resolvido) {
      const dResolvido = new Date(resolvido).toLocaleDateString();
      if (!resolvidosPorDia[dResolvido]) {
        resolvidosPorDia[dResolvido] = 0;
      }

      resolvidosPorDia[dResolvido]++;
      console.log()
    }
  });

  const dias = [];

  for (const dia in criadosPorDia) {
    if (!dias.includes(dia)) dias.push(dia)
  }
  for (const dia in resolvidosPorDia) {
    if (!dias.includes(dia)) dias.push(dia)
  }

  dias.sort()

  let backlogAcumulado = 0;
  const serieBacklog = [];

  dias.forEach(dia => {
    const criados = criadosPorDia[dia] || 0
    const resolvidos = resolvidosPorDia[dia] || 0

    backlogAcumulado += criados - resolvidos;

    serieBacklog.push(backlogAcumulado);
  })
  console.log({ dias, serieBacklog });

  return { dias, backlog: serieBacklog };
}
function plotarBurndown() {
  const { dias, backlog } =  gerarBurndown();
new ApexCharts(document.querySelector("#burndown"), {
  series: [{
    name: "Backlog",
    data: backlog
  }],
  chart: {
    type: "area",
    height: 260,
    toolbar: { show: false },
    zoom: { enabled: false },
    dropShadow: {
      enabled: true,
      top: 4,
      left: 0,
      blur: 4,
      opacity: 0.2
    }
  },
  stroke: {
    width: 3,
    curve: "smooth"
  },
  markers: {
    size: 4,
    hover: { size: 7 }
  },
  colors: ["#556cd6"],
  fill: {
    type: "gradient",
    gradient: {
      shadeIntensity: 1,
      opacityFrom: 0.4,
      opacityTo: 0.05,
      stops: [0, 90, 100]
    }
  },
  grid: {
    borderColor: "#e0e0e0",
    strokeDashArray: 4
  },
  xaxis: {
    categories: dias,
    labels: {
      rotate: -45,
      style: { fontSize: "12px" }
    }
  },
  yaxis: {
    labels: { style: { fontSize: "12px" } },
    title: { text: "Chamados em aberto" }
  },
  tooltip: {
    theme: "light",
    y: { formatter: val => `${val} chamados` }
  },
}).render();


}

async function buscarAlertasJira(params) {
  const resposta = await fetch("/alertasJira/buscarAlertasJira")
  const alertas = await resposta.json()
console.log(alertas)
alertas.forEach(alerta=>{
  let prioridade=""
  if(alerta.valor_lido<=alerta.max_permitido *1.1 && alerta.valor_lido>=alerta.min_permitido*0.9){
    prioridade="Low"
  }
  else if(alerta.valor_lido<=alerta.max_permitido*1.2 && alerta.valor_lido>=alerta.min_permitido*0.8){
    prioridade="Medium"
  }
  else{
    prioridade="High"
  }
 
})
  return alertas
  
}


async function criarAlerta(valor, componente, hospital, min, max, area, numeroSerie, timestamp, prioridade) {
const resposta =await buscarAlertasDuplicadosJira(numeroSerie,componente)
const respostajson=await resposta
console.log("RESPOSTA JSON")
console.log(resposta)
if(resposta.existe==true){
console.log("CHAMADO EVITADO")
return
}
console.log(prioridade)

  const issue = {
    fields: {
      project: { key: "KAN" },
      issuetype: { name: "Request" },
      priority: { name: prioridade},
      summary: `Alerta de ${componente} para o equipamento ${numeroSerie} no hospital ${hospital} `,
      customfield_10091: hospital,
      customfield_10092: area,
      customfield_10125: numeroSerie,
      customfield_10126: componente,
      duedate: new Date(new Date().getTime() + 72 * 60 * 60 * 1000).toISOString().split('T')[0],

    }
  };

  try {
    const resposta = await fetch("/jira/criar", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ issue })
    });
    const data = await resposta.json();
    console.log("✔️ Chamado criado:", data.key);
  } catch (e) {
    console.error("Erro ao criar chamado:", e);
  }
}

async function processarTodosOsAlertas() {
  const alertas = await buscarAlertasJira()

  const resposta = await fetch("/jira/processarAlertas", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(alertas)
  });

  const resultado = await resposta.json();
  console.log("Resultado:", resultado);
}



  var options = {
    series: [76],
    chart: {
      type: 'radialBar',
      offsetY: -20,
      sparkline: {
        enabled: true
      }
    },
    plotOptions: {
      radialBar: {
        startAngle: -90,
        endAngle: 90,
        track: {
          background: "#e7e7e7",
          strokeWidth: '97%',
          margin: 5, 
          dropShadow: {
            enabled: true,
            top: 2,
            left: 0,
            color: '#444',
            opacity: 1,
            blur: 2
          }
        },
        dataLabels: {
          name: {
            show: false
          },
          value: {
            offsetY: -2,
            fontSize: '22px'
          }
        }
      }
    },
    grid: {
      padding: {
        top: -10
      }
    },
    fill: {
      type: 'gradient',
      gradient: {
        shade: 'light',
        shadeIntensity: 0.4,
        inverseColors: false,
        opacityFrom: 1,
        opacityTo: 1,
        stops: [0, 50, 53, 91]
      },
    },
    labels: ['Average Results'],
  };

  var chart = new ApexCharts(document.querySelector("#chart"), options);
  chart.render();

</script>