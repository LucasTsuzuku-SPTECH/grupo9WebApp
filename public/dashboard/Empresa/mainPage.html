<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="./../../css/dashboards.css">
  <link rel="icon" href="/assets/imgs/Zephyrus.ico" />
  <title>Dashboard - Página Principal</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://kit.fontawesome.com/9f7414eb10.js" crossorigin="anonymous"></script>
  <script src="../../js/sessao.js"></script>

  <!-- CSS Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- JS Bootstrap -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <style>
    .corPrincipal {
      background: #264653;
    }

    .navbar-toggler-icon {
      filter: invert(1);

    }

    .containerTitulo .logo-titulo {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-direction: row;
    }


    .titulo {
      font-size: 28px;
      font-weight: 600;
      color: white;
      letter-spacing: 1px;
      margin: 0;
    }


    .containerTitulo {
      display: flex;
      align-items: start;
      margin-left: 20px;

    }

    .nav-item a:hover {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 4px;
    }

    .nav-item-selected {
      background: #30a799;
      border-radius: 4px;

    }

    .nav-item-selected a:hover {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 4px;

    }

    #offcanvasNavbar {
      width: 16%;
    }

    /* Botão de Sair */
    .btn-sair {
      display: flex;
      align-items: center;
      gap: 10px;
      background-color: #e63946;
      color: #fff !important;
      font-size: 20px;
      font-weight: bold;
      padding: 10px;
      border-radius: 6px;
      width: 90%;
      align-self: center;
      justify-content: center;
      transition: 0.2s;
      text-decoration: none;
    }

    .btn-sair:hover {
      background-color: #c92f3e;
    }

    /* Abrir chamado */
    .btn-suporte {
      display: flex;
      align-items: center;
      gap: 10px;
      color: #f5f6fa !important;
      font-size: 20px;
      padding: 8px 10px;
      justify-content: center;
      text-decoration: none;
      margin-bottom: 12px;
    }

    .icon {
      width: 22px;
      height: 22px;
      filter: invert(1);
    }
  </style>

</head>

<body onload="carregarSalasHosp()">
  <div class="div-pai">
    <!-- Cabeçalho -->
    <nav class="navbar corPrincipal fixed-top py-3">
      <div class="container-fluid justify-content-start ">
        <button class="navbar-toggler" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasNavbar"
          aria-controls="offcanvasNavbar" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon text-white"></span>
        </button>
        <div class="containerTitulo">
          <div class="logo-titulo">
            <img src="/assets/imgs/Zephyrus_2png.png" style="width: 50px;" alt="">
            <h1 class="titulo">Zephyrus</h1>
          </div>

          <div class="offcanvas offcanvas-start corPrincipal" tabindex="-1" id="offcanvasNavbar"
            aria-labelledby="offcanvasNavbarLabel">
            <img src="/assets/imgs/Zephyrus_2png.png"
              style="width: 170px; align-self: center; margin-bottom: 10px; margin-top: 20px;" alt="">
            <div class="offcanvas-header" style="border-bottom:2px solid rgba(255, 255, 255, 0.5);">
              <h4 class="offcanvas-title " style="color: #f5f6fa; " id="offcanvasNavbarLabel">Menu</h4>
              <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas"
                aria-label="Close"></button>
            </div>
            <div class="offcanvas-body d-flex flex-column">
              <ul class="navbar-nav justify-content-start flex-grow-1 pe-3">
                <li class="nav-item-selected" style="width: 100%;">
                  <a id="navMain" class="nav-link active" style="padding: 5px; color: #f5f6fa; font-size: 22px;"
                    href="./mainPage.html">Página
                    principal</a>
                </li>
                <li class="nav-item" style="width: 100%;">
                  <a class="nav-link active" style="padding: 5px; color: #f5f6fa;  font-size: 22px;"
                    href="./controleHospitais.html">Hospitais</a>
                </li>
                <li class="nav-item" style="width: 100%;">
                  <a class="nav-link active" style="padding: 5px; color: #f5f6fa;  font-size: 22px;"
                    href="./contas.html">Contas</a>
                </li>
              </ul>
              <ul class="navbar-nav d-flex flex-column flex-grow-1 pe-3">
                <li class="nav-item mt-auto d-flex justify-content-center" style="width: 100%;">
                  <a class="btn-suporte" href="/index">
                    <img style="width: 40px;" src="/assets/imgs/headphoneIcon.png" alt="">
                    Abrir chamado
                  </a>
                </li>
                <li class="nav-item d-flex justify-content-center" style="width: 100%;">
                  <a class="btn-sair" href="/index.html" onclick="sessionStorage.clear()">
                    <img class="icon" src="https://cdn-icons-png.flaticon.com/512/1828/1828479.png" alt="Logout">
                    Sair
                  </a>
                </li>
              </ul>
            </div>
          </div>
        </div>
    </nav>

    <div class="offcanvas offcanvas-start bg-dark text-white" tabindex="-1" id="sidebarOffcanvas"
      aria-labelledby="sidebarOffcanvasLabel">
      <div class="offcanvas-header justify-content-center">
        <img src="/assets/imgs/Zephyrus_2png.png" alt="Logo" style="height: 40px;">
        <button type="button" class="btn-close text-reset btn-close-white" data-bs-dismiss="offcanvas"
          aria-label="Close"></button>
      </div>
      <div class="offcanvas-body d-flex flex-column">
        <h5 class="offcanvas-title mb-3" id="sidebarOffcanvasLabel">Menu</h5>
        <nav class="nav flex-column flex-grow-1">
          <a class="nav-link text-white active bg-primary" href="./mainPage.html">Página principal</a>
          <a class="nav-link text-white" href="./controleSalas.html">Salas</a>
          <a class="nav-link text-white" href="./contas.html">Contas</a>
        </nav>
        <div class="mt-auto pt-3 border-top">
          <a class="btn btn-outline-light w-100" href="https://suaempresa.atlassian.net/secure/CreateIssue!default.jspa"
            target="_blank">
            Abrir Chamado <i class="fa-solid fa-headset"></i>
          </a>
        </div>
      </div>
    </div>

    <br><br><br><br>
    

    <div class="conteudo-main">
      <div style="width: 100%; display: flex; flex-direction: row; justify-content: center;">
        <div class="kpiDash2">
          <h2 id="maisIntercorrencia"></h2>Hospital com mais intercorrências
        </div>
        <div class="kpiDash2">
          <h2 id="intercorrenciasAgora"></h2>Hospitais com intercorrências no momento
        </div>
      </div>

      <div style="width: 100%; display: flex; flex-direction: row; justify-content: center;">
        <div class="graficoContainer2">
          <div class="graficoHeader">Ranking de intercorrência por hospitais (semanal):</div>
          <div class="tabelaWrapper">
            <table id="rankingHosp" class="graficoTabela2">
              <thead>
                <tr>
                  <th>Posição</th>
                  <th>Hospital</th>
                  <th>Total de Intercorrências</th>
                </tr>
              </thead>
            </table>
          </div>
        </div>


        <div class="graficoContainer2">
          <div class="graficoHeader">Intercorrência por hospital (semanal):</div>
          <canvas id="intercorrenciaHosp"></canvas>
        </div>
      </div>


      <div class="graficoContainer2">
        <div class="graficoHeader">Intercorrências por área do hospital <select onchange="filtrarAreaHosp()"
            class="selectHospitais" name="" id="selectHospitais">
            <option value="">Selecione um hospital...</option>
          </select>
        </div>
        <canvas id="intercorrenciaAreaHosp" style="width: 650px; height: 500px;"></canvas>
      </div>

    </div>
</body>

</html>





<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
  function toggleSidebar() {
    const sidebar = document.getElementById("sidebarModal");
    const icone = document.getElementById("icone");

    sidebar.classList.toggle("active");
  }

  function mostrarNavbar() {
    const larguraTela = window.innerWidth;
    var menu = document.getElementById("navbar");
    var icone = document.getElementById("icone");

    if (larguraTela < 1342) {
      if (getComputedStyle(menu).display == 'none') {
        menu.style.display = "flex";
        icone.classList.remove("fa-bars");
        icone.classList.add("fa-times");
      } else {
        menu.style.display = "none";
        icone.classList.remove("fa-times");
        icone.classList.add("fa-bars");
      }
    }
  }
  function Sair() {
    const sair = document.getElementById("sair")

    if (sair) {
      localStorage.removeItem("email")
      localStorage.removeItem("senha")

      sessionStorage.clear()
      console.log(sessionStorage)

      window.location.href = "../../index.html"
    }
  }




  var hospAgrupado;

  async function carregarSalasHosp() {
    try {
      const resposta = await fetch(`/controle/listar/hospitais/salas`);
      const salas = await resposta.json();
      const container = document.querySelector(".conteudo-principal");

      let total = salas.length, estavel = 0, alerta = 0, critico = 0;
      var areas = [];
      var salaEst = [];
      var salaAlert = [];
      var salaCri = [];

      for (const sala of salas) {
        if (!areas.includes(sala.area)) {
          areas.push(sala.area)
        }

        // Buscar ventiladores da sala
        const respV = await fetch(`/controle/hospitais/${sala.idSala}/ventiladores`);
        var ventiladores = respV.status === 204 ? [] : await respV.json();

        // --- MOCK ALERTAS ---
        let totalAlertas = 0;

        // Distribuir alertas de acordo com o status da sala
        // Decide primeiro o status do hospital
        let statusSala;
        let alertasHosp = 0;
        const sorteio = Math.random();

        if (sorteio < 0.33) {
          statusSala = "estavel";
          ventiladores.forEach(v => v.alertas = 0);
          totalAlertas = 0;

        } else if (sorteio < 0.66) {
          statusSala = "alerta";
          // Gera no máximo 2 alertas no total
          totalAlertas = Math.floor(Math.random() * 3); // 0,1,2
          let restantes = totalAlertas;
          ventiladores.forEach(v => {
            if (restantes > 0) {
              v.alertas = 1;
              alertasHosp += v.alertas
              restantes--;
            } else {
              v.alertas = 0;
            }
          });
        } else {
          statusSala = "critico";
          // Gera 3 a 6 alertas no total
          totalAlertas = 3 + Math.floor(Math.random() * 4); // 3 a 6
          let restantes = totalAlertas;
          ventiladores.forEach(v => {
            if (restantes > 0) {
              const qtd = Math.min(restantes, Math.floor(Math.random() * 3) + 1); // 1 a 3
              v.alertas = qtd;
              alertasHosp += v.alertas
              restantes -= qtd;
            } else {
              v.alertas = 0;
            }
          });
        }




        // Guardar ventiladores com alertas simulados no próprio objeto
        sala.ventiladoresMock = ventiladores;
        sala.statusSala = statusSala;
        sala.alertasTotais = alertasHosp;

        // Contabilizar
        if (statusSala === "estavel") {
          estavel++;
          salaEst.push(sala)
        };

        if (statusSala === "alerta") {
          alerta++;
          salaAlert.push(sala)
        }
        if (statusSala === "critico") {
          critico++;
          salaCri.push(sala);
        }
      }


      //KPIs
      var qtdHospIntercorrencias = 0;
      var maiorErros = 0;
      var hospMaisIntercorrencia;

      hospAgrupado = Object.values(Object.groupBy(salas, s => s.idHospital));

      for (let i = 0; i < hospAgrupado.length; i++) {
        let totalAlertasHosp = 0;
        for (let j = 0; j < hospAgrupado[i].length; j++) {
          totalAlertasHosp += hospAgrupado[i][j].alertasTotais;
        }

        if (totalAlertasHosp > maiorErros) {
          maiorErros = totalAlertasHosp;
          hospMaisIntercorrencia = hospAgrupado[i][0];
        }
      }


      for (let i = 0; i < hospAgrupado.length; i++) {
        for (let j = 0; j < hospAgrupado[i].length; j++) {
          if (hospAgrupado[i][j].alertasTotais != 0) {
            qtdHospIntercorrencias++;
            break;
          }
        }
      }

      document.getElementById('maisIntercorrencia').innerHTML = hospMaisIntercorrencia.nomeHospital;
      document.getElementById('intercorrenciasAgora').innerHTML = qtdHospIntercorrencias;




      //Ranking e Gráficos
      const listRanking = [];
      var nomesHospitais = [];
      var dadosHospitais = [];


      for (let i = 0; i < hospAgrupado.length; i++) {
        let totalAlertasHosp = 0;

        for (let j = 0; j < hospAgrupado[i].length; j++) {
          totalAlertasHosp += hospAgrupado[i][j].alertasTotais;
        }

        listRanking.push({
          idHospital: hospAgrupado[i][0].idHospital,
          nomeHospital: hospAgrupado[i][0].nomeHospital,
          totalAlertas: totalAlertasHosp
        });
      }

      listRanking.sort((a, b) => b.totalAlertas - a.totalAlertas);

      for (let i = 0; i < listRanking.length; i++) {
        document.getElementById("rankingHosp").innerHTML += `
              <th>${[i + 1]}°</th>
              <th>${listRanking[i].nomeHospital}</th>
              <th>${listRanking[i].totalAlertas}</th>
            `

        document.getElementById("selectHospitais").innerHTML += `<option value="${listRanking[i].idHospital}">${listRanking[i].nomeHospital}</option>`

        nomesHospitais.push(listRanking[i].nomeHospital);
        dadosHospitais.push(listRanking[i].totalAlertas);
      }





      const grafIntercorrenciaHosp = document.getElementById('intercorrenciaHosp');
      grafIntercorrenciaHosp.style.margin = "0px"
      new Chart(grafIntercorrenciaHosp, {
        type: 'bar',
        data: {
          labels: nomesHospitais,
          datasets: [{
            backgroundColor: '#264653',
            label: 'Total de intercorrências',
            data: dadosHospitais,
            borderWidth: 2,
          }]
        },
        options: {
          indexAxis: 'y',
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                font: {
                  size: 15
                }
              }
            },
            x: {
              ticks: {
                font: {
                  size: 15
                }
              }
            }
          }
        }
      });

      console.log(hospAgrupado)

    } catch (erro) {
      console.error("Erro:", erro);
    }
  }






  var areas = [];
  var alertasArea = [];
  let grafico;

  function filtrarAreaHosp() {
    areas = [];
    alertasArea = [];

    var hospSelecionado = document.getElementById("selectHospitais").value;

    for (let i = 0; i < hospAgrupado.length; i++) {
      for (let j = 0; j < hospAgrupado[i].length; j++) {
        for (let k = 0; k < hospAgrupado[i][j]['ventiladoresMock'].length; k++)
          if (!areas.includes(hospAgrupado[i][j]['ventiladoresMock'][k].area)) {
            areas.push(hospAgrupado[i][j]['ventiladoresMock'][k].area)
          };
      }
    }

    for (let a = 0; a < areas.length; a++) {
      const areaAtual = areas[a];
      let alerta = 0;

      for (let j = 0; j < hospAgrupado.length; j++) {
        for (let k = 0; k < hospAgrupado[j].length; k++) {
          const hosp = hospAgrupado[j][k];

          if (hosp.idHospital == hospSelecionado) {
            const ventiladores = hosp['ventiladoresMock'];

            for (let l = 0; l < ventiladores.length; l++) {
              if (ventiladores[l].area == areaAtual) {
                alerta += ventiladores[l].alertas;
              }
            }
          }
        }
      }

      alertasArea.push(alerta);
    }

    if (grafico) grafico.destroy();

    const grafIntercorrenciaAreaHosp = document.getElementById('intercorrenciaAreaHosp');
    grafIntercorrenciaAreaHosp.width = 1600;

    grafico = new Chart(grafIntercorrenciaAreaHosp, {
      type: 'bar',
      data: {
        labels: areas,
        datasets: [{
          backgroundColor: '#264653',
          label: 'Total de intercorrências',
          data: alertasArea,
          borderWidth: 2,
        }]
      },
      options: {
        scales: {
          y: {
            beginAtZero: true,
            ticks: {
              font: {
                size: 20
              }
            }
          },
          x: {
            ticks: {
              maxRotation: 0,
              minRotation: 0,
              font: {
                size: 20
              }
            }
          }
        }
      }
    });
  }










</script>