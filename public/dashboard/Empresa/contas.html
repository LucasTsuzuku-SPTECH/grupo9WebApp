<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="./../../css/dashboards.css">
  <link rel="icon" href="../assets/imgs/Zephyrus_2png.png" />
  <title>Dashboard - Contas</title>
  <script src="https://kit.fontawesome.com/9f7414eb10.js" crossorigin="anonymous"></script>
  <script src="../../js/sessao.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <!-- CSS Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- JS Bootstrap -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</head>

<body onload="puxarDados()">
  <div class="div-pai">

    <!-- Cabeçalho -->
    <header>
      <div class="header-container">
        <div class="div-hamburguer">
          <!-- Botão Hamburguer -->
          <a class="navbar-mob" onclick="toggleSidebar()">
            <i id="icone" class="fa-solid fa-bars fa-2x"></i>
          </a>
        </div>
        <h2>DASHBOARD - CONTROLE DE CONTAS</h2>
        <div class="div-pai-perfil">
          <div class="div-linha"></div>
          <div class="div-todo-perfil">
            <div class="div-filho-perfil">
              <img src="../../assets/imgs/profile.png" alt="imagem de perfil" class="img-perfil" />
              <img src="../../assets/imgs/seta-para-baixo-braca.png" alt="ver opções" class="img-seta" />
            </div>
            <div class="div-opcoes">
              <div class="div-opcao-sair">
                <button style="border: none;" onclick="limparSessao()" id="sair"><span>Sair</span></button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </header>

    <!-- Sidebar Modal -->
    <div id="sidebarModal" class="sidebar-modal">
      <div class="sidebar-header">
        <span>Menu</span>
        <button onclick="toggleSidebar()" class="btn-fechar">&times;</button>
      </div>
      <nav class="sidebar-nav">
        <a style="text-decoration: none;" href="./mainPage.html">Página principal</a>
        <a style="text-decoration: none;" href="./controleHospitais.html">Hospitais</a>
        <a style="text-decoration: none;" href="./contas.html">Contas</a>
      </nav>
    </div>

    <div class="conteudo-principal">

      <div class="div-flex">
        <div class="div-block">
          <div class="div-links-contas">
            <button class="btn-adicionar" data-bs-toggle="modal" data-bs-target="#modalAdicionarUsuario">
              Adicionar novo usuário
            </button>
          </div>

          <div class="div-procura">
            <div class="div-ipt-procura">
              <label for="">Procure pelo Representante:</label>
              <input type="text" id="ipt_representante" class="ipt_procura"
                oninput="buscarRepresentante(ipt_representante.value)" placeholder="Nome do Representante">
            </div>
            <div class="div-ipt-procura">
              <label for="">Filtrar por Hospital</label>
              <select name="" id="select_hospital" onchange="selecionarHospital()" class="ipt_procura">
                <option value="todos">Todos</option>
              </select>
            </div>
            <div class="div-ipt-procura">
              <label for="">Filtrar por atividade:</label>
              <select name="" id="select_atividade" onchange="selecionarAtividade()" class="ipt_procura">
                <option value="Ambos">Ambos</option>
                <option value="ativo">Ativo</option>
                <option value="inativo">Inativo</option>
              </select>
            </div>
          </div>

          <div class="mostrarUsuarios">
            <table>
              <thead>
                <tr class="nomeColuna">
                  <th class="colunaUsuario" style="text-align: center;">Hospital | Empresa</th>
                  <th class="colunaRepresentante" style="text-align: center;">Representante</th>
                  <th class="colunaEmail" style="text-align: center;">E-mail</th>
                  <th class="colunaTipoAcesso" style="text-align: center;">Tipo acesso</th>
                  <th class="colunaStatus" style="text-align: center;">Status</th>
                  <th class="colunaEditar" style="text-align: center;">Editar</th>
                </tr>
              </thead>
              <tbody id="tbody_usuarios">
              </tbody>
            </table>
          </div>

          <!-- Modal Adicionar Usuário -->
          <div class="modal fade" id="modalAdicionarUsuario" tabindex="-1" aria-labelledby="modalLabelUsuario"
            aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
              <div class="modal-content">

                <div class="modal-header">
                  <h5 class="modal-title" id="modalLabelUsuario">Adicionar Novo Usuário</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
                </div>

                <div class="modal-body">
                  <form id="formAdicionarUsuario">
                    <div class="mb-3">
                      <label for="nomeModal" class="form-label">Nome</label>
                      <input type="text" class="form-control" id="nomeModal" required>
                    </div>
                    <div class="mb-3">
                      <label for="emailModal" class="form-label">E-mail</label>
                      <input type="email" class="form-control" id="emailModal" required>
                    </div>
                    <div class="mb-3">
                      <label for="senhaModal" class="form-label">Senha</label>
                      <input type="password" class="form-control" id="senhaModal" required>
                    </div>
                    <div class="mb-3">
                      <label for="confirmSenhaModal" class="form-label">Confirmar Senha</label>
                      <input type="password" class="form-control" id="confirmSenhaModal" required>
                    </div>
                    <div class="mb-3">
                      <label for="perfilModal" class="form-label">Perfil</label>
                      <select class="form-select" id="perfilModal" required>
                        <option value="" selected disabled>Selecione</option>
                        <option value="empresa">Funcionário Empresa</option>
                        <option value="adminEmpresa">Admin Empresa</option>
                        <option value="hospital">Funcionário Hospital</option>
                        <option value="adminHospital">Admin Hospital</option>
                      </select>
                    </div>
                    <div class="mb-3" id="divHospitalModal" style="display:none;">
                      <label for="hospitalModal" class="form-label">Hospital</label>
                      <select class="form-select" id="hospitalModal"></select>
                    </div>
                  </form>
                </div>

                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                  <button type="button" class="btn btn-primary" onclick="cadastrarModal()">Adicionar</button>
                </div>

              </div>
            </div>
          </div>

          <!-- Modal Editar Usuário -->
          <div class="modal fade" id="modalEditarUsuario" tabindex="-1" aria-labelledby="modalLabelEditarUsuario"
            aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
              <div class="modal-content">

                <div class="modal-header">
                  <h5 class="modal-title" id="modalLabelEditarUsuario">Editar Usuário</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
                </div>

                <div class="modal-body">
                  <form id="formEditarUsuario">
                    <div class="mb-3">
                      <label for="nomeEditar" class="form-label">Nome</label>
                      <input type="text" class="form-control" id="nomeEditar" required>
                    </div>
                    <div class="mb-3">
                      <label for="emailEditar" class="form-label">E-mail</label>
                      <input type="email" class="form-control" id="emailEditar" required>
                    </div>
                    <div class="mb-3">
                      <label for="perfilEditar" class="form-label">Perfil</label>
                      <select class="form-select" id="perfilEditar" required>
                        <option value="" selected disabled>Selecione</option>
                        <option value="empresa">Funcionário Empresa</option>
                        <option value="adminEmpresa">Admin Empresa</option>
                        <option value="hospital">Funcionário Hospital</option>
                        <option value="adminHospital">Admin Hospital</option>
                      </select>
                    </div>
                    <div class="mb-3" id="editarModalHospital" style="display:none;">
                      <label for="hospitalEditarModal" class="form-label">Hospital</label>
                      <select class="form-select" id="hospitalEditarModal"></select>
                    </div>
                  </form>
                </div>

                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                  <button type="button" class="btn btn-primary" onclick="editarUsuarioModal()">Salvar</button>
                </div>

              </div>
            </div>
          </div>

</body>

<script>
  // -------------------- VARIÁVEIS GLOBAIS ----------------------
  let usuarios = [];
  let hospitais = [];
  let usuarioSelecionado = null; // id do usuário
  let usuarioEditarId = null;

  // -------------------- FUNÇÕES AUXILIARES ----------------------
  function criarLinhaUsuario(usuario, index) {
    const tr = document.createElement('tr');
    tr.innerHTML = `
    <td class="colunaUsuario">${usuario.nomeInstituicao ?? "-"}</td>
    <td class="colunaRepresentante">${usuario.nome}</td>
    <td class="colunaEmail">${usuario.email}</td>
    <td class="colunaTipoAcesso">${usuario.perfil}</td>
    <td class="colunaAcesso">
      <button class="btn-status ${usuario.statusUser === 'ativo' ? 'btn-ativo' : 'btn-inativo'}"
        onclick="alterarAcesso(${index})">
        ${usuario.statusUser.charAt(0).toUpperCase() + usuario.statusUser.slice(1)}
      </button>
    </td>
    <td class="colunaEditar" style="text-align:center;">
      <button onclick="abrirModalEditar(${usuario.id_usuario})" style="background:transparent;border:none;">
        <img src="../../assets/imgs/editar.png" alt="Editar" style="width:20px;height:20px;">
      </button>
    </td>
  `;
    tr.style.backgroundColor = index % 2 === 0 ? '#d3d3d3' : '#ffffff';
    return tr;
  }

  function preencherTabela(lista) {
    const tbody = document.getElementById('tbody_usuarios');
    tbody.innerHTML = '';
    lista.forEach((u, i) => tbody.appendChild(criarLinhaUsuario(u, i)));
  }

  // -------------------- CRUD ----------------------
  async function puxarDados() {
    try {
      const res = await fetch("/contas/contas");
      if (!res.ok) throw new Error("Erro na resposta da API");
      usuarios = await res.json();
      preencherTabela(usuarios);
      preencherSelectHospital();
    } catch (err) {
      console.error(err);
    }
  }

  async function alterarAcesso(index) {
    const usuario = usuarios[index];
    const novoStatus = usuario.statusUser.toLowerCase() === "ativo" ? "inativo" : "ativo";
    try {
      await fetch(`/contas/alterarAcesso/${usuario.id_usuario}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ statusUser: novoStatus })
      });
      usuarios[index].statusUser = novoStatus;
      preencherTabela(usuarios);
    } catch (err) {
      console.error(err);
    }
  }

  // -------------------- FILTROS ----------------------
  function buscarRepresentante(nome) {
    if (!nome) return puxarDados();
    const filtro = usuarios.filter(u =>
      u.nome.replace(/\s/g, "").toLowerCase().includes(nome.replace(/\s/g, "").toLowerCase())
    );
    preencherTabela(filtro);
  }

  function selecionarHospital() {
    const idHospital = document.getElementById('select_hospital').value;
    if (idHospital === "todos") return puxarDados();

    // Convertendo para number para comparar corretamente
    const filtro = usuarios.filter(u => u.fk_hospital == Number(idHospital));
    preencherTabela(filtro);
  }

  function selecionarAtividade() {
    const atividade = document.getElementById('select_atividade').value;
    if (atividade === "Ambos") return puxarDados();
    preencherTabela(usuarios.filter(u => u.statusUser === atividade));
  }

  // -------------------- HOSPITAIS ----------------------
  async function preencherSelectHospital() {
    const selectHospitais = document.getElementById('select_hospital');
    selectHospitais.innerHTML = `<option value="todos">Todos</option>`;
    try {
      const resp = await fetch("/contas/listarHospitais");
      hospitais = await resp.json();
      hospitais.forEach(h =>
        selectHospitais.innerHTML += `<option value="${h.id_hospital}">${h.nomeHospital}</option>`
      );
    } catch (err) {
      console.error("Erro ao listar hospitais", err);
    }
  }

  async function carregarHospitaisModal() {
    const hospitalAddModal = document.getElementById('hospitalModal');
    hospitalAddModal.innerHTML = '<option disabled selected>Selecione um hospital</option>';
    try {
      const resp = await fetch('/contas/listarHospitais');
      const lista = await resp.json();
      lista.forEach(h => hospitalAddModal.innerHTML += `<option value="${h.id_hospital}">${h.nomeHospital}</option>`);
    } catch (err) {
      console.error('Erro ao carregar hospitais:', err);
    }
  }

  async function carregarEditarModal() {
    const hospitalEditarModal = document.getElementById('hospitalEditarModal');
    hospitalEditarModal.innerHTML = '<option disabled selected>Selecione um hospital</option>';
    try {
      const resp = await fetch('/contas/listarHospitais');
      const lista = await resp.json();
      lista.forEach(h => hospitalEditarModal.innerHTML += `<option value="${h.id_hospital}">${h.nomeHospital}</option>`);
    } catch (err) {
      console.error('Erro ao carregar hospitais:', err);
    }
  }

  // -------------------- MODAIS ----------------------

  function abrirModalEditar(id) {
    usuarioEditarId = id;
    const u = usuarios.find(x => x.id_usuario === id);
    document.getElementById("nomeEditar").value = u.nome;
    document.getElementById("emailEditar").value = u.email;
    document.getElementById("perfilEditar").value = u.perfil;
    new bootstrap.Modal(document.getElementById("modalEditarUsuario")).show();
  }

  async function editarUsuarioModal() {
    const nome = document.getElementById("nomeEditar").value;
    const email = document.getElementById("emailEditar").value;
    const perfil = document.getElementById("perfilEditar").value;
    const fkEmpresa = sessionStorage.getItem("EMPRESA_USUARIO"); 
    let fkHospital = null;

    // Pega o select correto do modal de editar
    const hospitalModal = document.getElementById('hospitalEditarModal');

    if (perfil === "hospital" || perfil === "adminHospital") {
        fkHospital = hospitalModal.value || null;
    }

    try {
        await fetch(`/contas/editar/${usuarioEditarId}`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ nome, email, perfil, fkEmpresa, fkHospital })
        });
        bootstrap.Modal.getInstance(document.getElementById("modalEditarUsuario")).hide();
        puxarDados();
        Swal.fire({ icon: 'success', title: 'Sucesso', text: 'Usuário editado com sucesso!', timer: 2000, showConfirmButton: false });
    } catch (err) {
        console.error(err);
        Swal.fire({ icon: 'error', title: 'Erro', text: 'Não foi possível editar o usuário!' });
    }
}


  // -------------------- CADASTRO ----------------------
  async function cadastrarModal() {
    const nome = document.getElementById("nomeModal").value;
    const email = document.getElementById("emailModal").value;
    const senha = document.getElementById("senhaModal").value;
    const confirmar = document.getElementById("confirmSenhaModal").value;
    const perfil = document.getElementById('perfilModal').value;
    const hospitalModal = document.getElementById('hospitalModal');
    if (senha !== confirmar) {
      Swal.fire({ icon: 'error', title: 'Erro', text: 'As senhas não coincidem!' });
      return;
    }
    let fkHospital = null;
    if (perfil === "hospital" || perfil === "adminHospital") fkHospital = hospitalModal.value;
    try {
      await fetch("/contas/cadastrarFunc", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          nomeServer: nome,
          emailServer: email,
          senhaServer: senha,
          perfilServer: perfil,
          fkEmpresaServer: sessionStorage.EMPRESA_USUARIO,
          fkHospitalServer: fkHospital
        })
      });
      Swal.fire({ icon: 'success', title: 'Sucesso', text: 'Usuário cadastrado com sucesso!', timer: 2000, showConfirmButton: false });
      document.getElementById("formAdicionarUsuario").reset();
      bootstrap.Modal.getInstance(document.getElementById("modalAdicionarUsuario")).hide();
      puxarDados();
    } catch (err) {
      console.error(err);
      Swal.fire({ icon: 'error', title: 'Erro', text: 'Não foi possível cadastrar o usuário!' });
    }
  }

  // -------------------- PERFIL SELECT ----------------------
  const perfilModal = document.getElementById('perfilModal');
  const divHospitalModal = document.getElementById('divHospitalModal');
  perfilModal.addEventListener('change', function () {
    if (this.value === 'hospital' || this.value === 'adminHospital') {
      divHospitalModal.style.display = 'block';
      carregarHospitaisModal();
    } else {
      divHospitalModal.style.display = 'none';
      document.getElementById('hospitalModal').innerHTML = '';
    }
  });


  const perfilEditar = document.getElementById('perfilEditar');
  const divEditar = document.getElementById('editarModalHospital');

  perfilEditar.addEventListener('change', function () {
    if (this.value === 'hospital' || this.value === 'adminHospital') {
      divEditar.style.display = 'block';
      carregarEditarModal(); // preenche o select do modal de editar
    } else {
      divEditar.style.display = 'none';
      document.getElementById('hospitalEditarModal').innerHTML = '';
    }
  });

  // -------------------- SIDEBAR ----------------------
  function toggleSidebar() {
    document.getElementById("sidebarModal").classList.toggle("active");
  }

  // -------------------- ONLOAD ----------------------
  window.onload = puxarDados;
</script>