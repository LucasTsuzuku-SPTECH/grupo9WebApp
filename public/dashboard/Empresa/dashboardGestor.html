<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Gestor Empresa</title>
    <link rel="icon" href="/assets/imgs/Zephyrus.icon" />
    <link rel="icon" href="/assets/imgs/Zephyrus_2png.png">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/dashboardGestor.css">

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet" />

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <script src="https://kit.fontawesome.com/9f7414eb10.js" crossorigin="anonymous"></script>

    <style>
        /* estilos gerais e do filtro */
        /* ... estilos existentes ... */

        /* Customizar tooltips */
        .tooltip-inner {
            background-color: #1f2937;
            border-radius: 6px;
            padding: 8px 12px;
            font-size: 0.875rem;
            font-weight: 500;
            max-width: 200px;
            text-align: center;
        }

        .tooltip.show {
            opacity: 1;
        }

        .bs-tooltip-top .tooltip-arrow::before {
            border-top-color: #1f2937;
        }

        .bs-tooltip-bottom .tooltip-arrow::before {
            border-bottom-color: #1f2937;
        }

        /* Cor do texto do tooltip */
        .tooltip-inner {
            color: #ffffff;
        }

        /* Sombra no tooltip */
        .tooltip.show {
            filter: drop-shadow(0 2px 8px rgba(0, 0, 0, 0.15));
        }

        .btn-group {
            gap: 0.5rem;
        }

        .filtro-periodo:checked+.btn {
            background-color: #30a799;
            border-color: #30a799;
            color: white;
        }

        .btn-outline-secondary:hover {
            background-color: #f8f9fa;
        }

        .filtro-periodo:checked+.btn:hover {
            background-color: #2a8f7f;
            border-color: #2a8f7f;
        }

        .zephyrus-bg-success {
            background-color: #30a799 !important;
        }

        .zephyrus-text-success {
            color: #30a799 !important;
        }

        .kpi-card-icon {
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            width: 48px;
            height: 48px;
            flex-shrink: 0;
        }

        .chart-container {
            position: relative;
            height: 250px;
            width: 100%;
        }

        .chart-container-lg {
            position: relative;
            height: 350px;
            width: 100%;
        }

        /* legendas customizadas */
        .legend-dot {
            height: 10px;
            width: 10px;
            border-radius: 50%;
            display: inline-block;
        }

        .legend-line {
            height: 4px;
            width: 32px;
            display: inline-block;
            vertical-align: middle;
        }

        @media (max-width: 768px) {
            .btn-group {
                flex-wrap: wrap;
                width: 100%;
            }

            .btn-group label {
                flex: 1 1 48%;
                font-size: 0.85rem;
            }

            .chart-container {
                height: 200px;
            }

            .chart-container-lg {
                height: 300px;
            }
        }
    </style>
</head>

<body>
    <!-- Cabeçalho -->
    <nav class="navbar corPrincipal fixed-top py-3">
        <div class="container-fluid justify-content-start">
            <button class="navbar-toggler" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasNavbar"
                aria-controls="offcanvasNavbar" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="containerTitulo">
                <div class="logo-titulo">
                    <img src="/assets/imgs/Zephyrus_2png.png" style="width: 50px;" alt="">
                    <h1 class="titulo">Zephyrus</h1>
                </div>
            </div>
        </div>
    </nav>

    <!-- Menu Offcanvas -->
    <div class="offcanvas offcanvas-start corPrincipal" tabindex="-1" id="offcanvasNavbar"
        aria-labelledby="offcanvasNavbarLabel">
        <img src="/assets/imgs/Zephyrus_2png.png"
            style="width: 136px; align-self: center; margin-bottom: 8px; margin-top: 16px;" alt="">
        <div class="offcanvas-header" style="border-bottom:2px solid rgba(255, 255, 255, 0.5);">
            <h4 class="offcanvas-title" style="color: #f5f6fa;" id="offcanvasNavbarLabel">Menu</h4>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas"
                aria-label="Close"></button>
        </div>
        <div class="offcanvas-body d-flex flex-column">
            <ul class="navbar-nav justify-content-start flex-grow-1 pe-3">
                <li class="nav-item-selected" style="width: 100%;">
                    <a id="navMain" class="nav-link active" style="padding: 4px; color: #f5f6fa; font-size: 18px;"
                        href="./dashboardGestor.html">Página principal</a>
                </li>
                <li class="nav-item" style="width: 100%;">
                    <a class="nav-link active" style="padding: 4px; color: #f5f6fa; font-size: 18px;"
                        href="./controleHospitais.html">Hospitais</a>
                </li>
                <li class="nav-item" style="width: 100%;">
                    <a class="nav-link active" style="padding: 4px; color: #f5f6fa; font-size: 18px;"
                        href="./contas.html">Contas</a>
                </li>
                <li class="nav-item" style="width: 100%;">
                    <a class="nav-link active" style="padding: 4px; color: #f5f6fa; font-size: 18px;"
                        href="./suporte.html">Suporte</a>
            </ul>
            <ul class="navbar-nav d-flex flex-column pe-1">
                <li class="nav-item d-flex justify-content-center" style="width: 100%;">
                    <a class="btn-sair" href="/index.html" onclick="sessionStorage.clear()">
                        <img class="icon" src="https://cdn-icons-png.flaticon.com/512/1828/1828479.png" alt="Logout">
                        Sair
                    </a>
                </li>
            </ul>
        </div>
    </div>

    <br><br><br><br>

    <main class="container my-4">
        <div class="mb-3 me-3">
            <p class="text-muted small mb-1">Período Selecionado</p>
            <p class="fw-bold text-dark" id="indicadorData" style="font-size: 1.2rem;">08/12/2025</p>
        </div>
        <div class="d-flex justify-content-between align-items-end mb-4 border-bottom pb-2">

            <div>
                <h2 class="fw-bold text-dark mb-1">Painel do Gestor</h2>
                <p class="text-muted mb-0">Visão geral da operação e monitoramento dos equipamentos</p>
            </div>

            <div class="d-none d-md-block">

                <div class="btn-group me-3" role="group">
                    <input type="radio" class="btn-check filtro-periodo" id="btnDiario" name="periodo" value="diario"
                        checked>
                    <label class="btn btn-outline-secondary" for="btnDiario"><i class="bi bi-calendar-day me-1"></i>
                        Diário</label>

                    <input type="radio" class="btn-check filtro-periodo" id="btnSemanal" name="periodo" value="semanal">
                    <label class="btn btn-outline-secondary" for="btnSemanal"><i class="bi bi-calendar-week me-1"></i>
                        Semanal</label>

                    <input type="radio" class="btn-check filtro-periodo" id="btnMensal" name="periodo" value="mensal">
                    <label class="btn btn-outline-secondary" for="btnMensal"><i class="bi bi-calendar-month me-1"></i>
                        Mensal</label>

                    <input type="radio" class="btn-check filtro-periodo" id="btnAnual" name="periodo" value="anual">
                    <label class="btn btn-outline-secondary" for="btnAnual"><i class="bi bi-calendar me-1"></i>
                        Anual</label>

                </div>

                <div class="dropdown d-inline-block">
                    <button class="btn btn-outline-secondary dropdown-toggle" type="button" id="dropdownModelo"
                        data-bs-toggle="dropdown">
                        <i class="bi bi-funnel me-1"></i> Todos os Modelos
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end" id="listaModelos" aria-labelledby="dropdownModelo">
                        <li><a class="dropdown-item filtro-modelo active" href="#" data-modelo="todos">Todos os
                                Modelos</a></li>
                        <li>
                            <hr class="dropdown-divider">
                        </li>
                    </ul>

                </div>

            </div>

        </div>


        <div class="row g-3 mb-4">
            <div class="col-md-4">
                <div class="card stat-card border-0 border-bottom border-danger border-5">
                    <div class="card-body shadow-bottom-right">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <p class="text-muted small mb-1">Coletas Críticas</p>
                                <p class="stat-value text-danger" id="criticosValue" data-bs-toggle="tooltip"
                                    data-bs-placement="top" title="Crítico: > 80%">2%</p>
                            </div>
                            <div class="bg-danger bg-opacity-10 p-3 rounded">
                                <i class="bi bi-x-circle stat-icon text-danger"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card stat-card border-0 border-bottom border-warning border-5">
                    <div class="card-body shadow-bottom-right">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <p class="text-muted small mb-1">Coletas em Atenção</p>
                                <p class="stat-value text-warning" id="atencaoValue" data-bs-toggle="tooltip"
                                    data-bs-placement="top" title="Atenção: entre 75% e 80%">6%</p>
                            </div>
                            <div class="bg-warning bg-opacity-10 p-3 rounded">
                                <i class="bi bi-exclamation-triangle stat-icon text-warning"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card stat-card border-0 border-bottom border-success border-5">
                    <div class="card-body shadow-bottom-right">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <p class="text-muted small mb-1">Coletas Operacionais</p>
                                <p class="stat-value text-success" id="operacionaisValue" data-bs-toggle="tooltip"
                                    data-bs-placement="top" title="Operacional: abaixo de 75%">0%</p>
                            </div>
                            <div class="bg-success bg-opacity-10 p-3 rounded">
                                <i class="bi bi-check-circle stat-icon text-success"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card uptime-card mb-4">
            <div class="card-body p-4">
                <div class="row align-items-start">
                    <div class="col-md-8">
                        <p class="text-black-50 mb-2">Taxa de Uptime Global</p>
                        <div class="d-flex align-items-baseline gap-3">
                            <h2 class="text-black uptime-percentage">0.%</h2>
                        </div>
                        <p class="text-black-50 mt-3">
                            <span class="text-black fw-bold">0</span> de
                            <span class="text-black fw-bold">0</span> das coletas dentro dos parâmetros
                            normais
                        </p>
                    </div>
                    <div class="col-md-4 text-md-end mt-3 mt-md-0">
                        <div class="sla-box" style="border: black;">
                            <p class="text-black-50 small mb-1">Objetivo SLA</p>
                            <p class="text-black h3 mb-0">95.0%</p>
                        </div>
                    </div>
                </div>
                <div class="border-top border-white border-opacity-25 mt-4 pt-3">
                    <div class="d-flex justify-content-between small">
                        <span class="text-black">Última atualização</span>
                        <span class="text-black">Há 2 minutos</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="card shadow-sm mb-4">
            <div class="card-body p-4">
                <div class="row align-items-start">
                    <div class="col-md-6 mb-3 mb-md-0">
                        <h5 class="card-title text-uppercase text-muted fw-bold">Tendência de Falhas por Modelo</h5>
                    </div>
                    <div class="col-md-6">
                        <div class="d-flex flex-wrap justify-content-md-end gap-3 small" id="legendaFalhas">
                        </div>
                    </div>
                </div>
                <div class="chart-container-lg mt-4">
                    <canvas id="failuresChart"></canvas>
                </div>
                <div
                    class="d-flex flex-wrap justify-content-center align-items-center gap-4 mt-4 text-body-secondary small">

                </div>
            </div>
        </div>

        <div class="row g-4 mb-4">
            <div class="col-lg-6">
                <div class="card h-100">
                    <div class="card-body">
                        <h5 class="card-title text-muted text-uppercase fw-bold mb-4"
                            style="font-size: 0.875rem; letter-spacing: 0.05em;">Risco por Área</h5>
                        <div class="chart-container">
                            <canvas id="riskChart"></canvas>
                        </div>
                        <p class="card-text text-center text-muted fw-semibold mt-3" style="font-size: 0.875rem;">
                            Foco de suporte deve ser na UTI
                        </p>
                    </div>
                </div>
            </div>

            <div class="col-lg-6">
                <div class="card h-100">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h5 class="card-title mb-0">Volume de Alertas</h5>
                            <span class="badge bg-light text-dark"></span>
                        </div>
                        <div class="chart-container">
                            <canvas id="alertsChart"></canvas>
                        </div>
                        <div class="border-top mt-4 pt-3">
                            <div class="d-flex justify-content-between small text-muted">
                                <span id="volumeAlerta">
                                    Total: <span class="fw-semibold text-dark">1.250 alertas este mês</span>
                                </span>
                                <span id="mediaAlerta">
                                    Média: <span class="fw-semibold text-dark">40.3 por dia</span>
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card shadow-sm border-0 mb-5">
            <div class="card-body p-4">
                <h1 class="card-title h3 mb-1 fw-bold text-dark">Status por Hospital</h1>
                <p class="card-subtitle text-muted">Distribuição de ventiladores por status operacional</p>
                <div class="row g-4 mt-3">
                    <div class="col-md-6">
                        <div class="card h-100 border-danger-subtle bg-danger-subtle bg-opacity-10">
                            <div class="card-body d-flex align-items-center p-3">
                                <div class="kpi-card-icon bg-danger-subtle me-3">
                                    <span class="material-icons-outlined text-danger">error_outline</span>
                                </div>
                                <div>
                                    <p class="mb-0 small text-danger fw-medium">Pior Experiência</p>
                                    <p class="h5 mb-1 fw-bold text-dark">Hospital das Clínicas</p>
                                    <p class="mb-0 text-danger fw-semibold">6.8% crítico</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card h-100 border-success-subtle bg-success-subtle bg-opacity-10">
                            <div class="card-body d-flex align-items-center p-3">
                                <div class="kpi-card-icon bg-success-subtle me-3">
                                    <span class="material-icons-outlined zephyrus-text-success">apartment</span>
                                </div>
                                <div>
                                    <p class="mb-0 small zephyrus-text-success fw-medium">Melhor Performance</p>
                                    <p class="h5 mb-1 fw-bold text-dark">Hospital São Lucas</p>
                                    <p class="mb-0 zephyrus-text-success fw-semibold">95.6% operacional</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="mt-5">
                    <div class="d-flex justify-content-end align-items-center gap-3 mb-2 small text-muted">
                        <div class="d-flex align-items-center gap-2">
                            <span class="zephyrus-bg-success"
                                style="width: 12px; height: 12px; border-radius: 2px;"></span>
                            <span>Operacional</span>
                        </div>
                        <div class="d-flex align-items-center gap-2">
                            <span class="bg-warning" style="width: 12px; height: 12px; border-radius: 2px;"></span>
                            <span>Atenção</span>
                        </div>
                        <div class="d-flex align-items-center gap-2">
                            <span class="bg-danger" style="width: 12px; height: 12px; border-radius: 2px;"></span>
                            <span>Crítico</span>
                        </div>
                        <button class="btn btn-link text-muted p-0 lh-1">
                            <span class="material-icons-outlined">filter_list</span>
                        </button>
                    </div>

                    <div class="mt-5 table-responsive">
                        <table class="table table-hover align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th class="fw-bold text-secondary" scope="col">Hospital</th>
                                    <th class="fw-bold text-secondary" scope="col">Total</th>
                                    <th class="fw-bold text-secondary" scope="col">Operacional</th>
                                    <th class="fw-bold text-secondary" scope="col">Atenção</th>
                                    <th class="fw-bold text-secondary" scope="col">Crítico</th>
                                    <th class="fw-bold text-secondary" scope="col">Disponib.</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td class="fw-medium">Hospital das Clínicas</td>
                                    <td class="text-muted">220</td>
                                    <td class="fw-semibold zephyrus-text-success">180</td>
                                    <td class="fw-semibold text-warning">25</td>
                                    <td class="fw-semibold text-danger">15</td>
                                    <td class="fw-semibold text-danger">81.8%</td>
                                </tr>
                                <tr>
                                    <td class="fw-medium">Hospital Geral</td>
                                    <td class="text-muted">155</td>
                                    <td class="fw-semibold zephyrus-text-success">138</td>
                                    <td class="fw-semibold text-warning">11</td>
                                    <td class="fw-semibold text-danger">6</td>
                                    <td class="fw-semibold text-warning">89.0%</td>
                                </tr>
                                <tr>
                                    <td class="fw-medium">Hospital Regional</td>
                                    <td class="text-muted">190</td>
                                    <td class="fw-semibold zephyrus-text-success">165</td>
                                    <td class="fw-semibold text-warning">18</td>
                                    <td class="fw-semibold text-danger">7</td>
                                    <td class="fw-semibold text-warning">86.8%</td>
                                </tr>
                                <tr>
                                    <td class="fw-medium">Hospital Santa Maria</td>
                                    <td class="text-muted">165</td>
                                    <td class="fw-semibold zephyrus-text-success">148</td>
                                    <td class="fw-semibold text-warning">12</td>
                                    <td class="fw-semibold text-danger">5</td>
                                    <td class="fw-semibold text-warning">89.7%</td>
                                </tr>
                                <tr>
                                    <td class="fw-medium">Hospital São Lucas</td>
                                    <td class="text-muted">180</td>
                                    <td class="fw-semibold zephyrus-text-success">172</td>
                                    <td class="fw-semibold text-warning">6</td>
                                    <td class="fw-semibold text-danger">2</td>
                                    <td class="fw-semibold zephyrus-text-success">95.6%</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // variaveis globais pra usar em tudo
        let dadosGestor = null;
        let periodoAtual = 'diario';
        let modeloAtual = 'todos';
        let chartsInstances = {
            riskChart: null,
            alertsChart: null,
            failuresChart: null
        };

        function atualizarIndicadorData() {
            const periodo = periodoAtual || 'diario';
            const dataEl = document.getElementById('indicadorData');

            if (!dataEl) return;

            const hoje = new Date();
            const dia = String(hoje.getDate()).padStart(2, '0');
            const mes = String(hoje.getMonth() + 1).padStart(2, '0');
            const ano = String(hoje.getFullYear()).slice(-2);
            const nomesMeses = ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho',
                'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
            const mesNome = nomesMeses[hoje.getMonth()];

            let textoData = '';

            switch (periodo) {
                case 'diario':
                    textoData = `${dia}/${mes}/${ano}`;
                    break;
                case 'semanal':
                    const semanaDoAno = Math.ceil((hoje - new Date(hoje.getFullYear(), 0, 1)) / 86400000 / 7);
                    textoData = `Semana ${semanaDoAno}/${ano}`;
                    break;
                case 'mensal':
                    textoData = `${mesNome}/${ano}`;
                    break;
                case 'anual':
                    textoData = `${hoje.getFullYear()}`;
                    break;
            }

            dataEl.textContent = textoData;
        }




        // aqui cuidamos dos eventos de clique no filtro de periodo
        function inicializarFiltro() {
            const botoesperiodo = document.querySelectorAll('.filtro-periodo');
            botoesperiodo.forEach(botao => {
                botao.addEventListener('change', (e) => {
                    periodoAtual = e.target.value;
                    atualizarIndicadorData(); // Atualizar data
                    carregarDadosGestor();
                });
            });
        }

        // aqui a gente cuida do dropdown de modelos e seus filtros
        function inicializarFiltroModelo() {
            document.addEventListener('click', (e) => {
                if (e.target.classList.contains('filtro-modelo')) {
                    e.preventDefault();
                    document.querySelectorAll('.filtro-modelo').forEach(item => item.classList.remove('active'));
                    e.target.classList.add('active');
                    modeloAtual = e.target.dataset.modelo;
                    document.getElementById('dropdownModelo').innerHTML = `<i class="bi bi-funnel me-1"></i> ${e.target.textContent}`;
                    carregarDadosGestor();
                }
            });
        }

        function preencherDropdownModelos(modelos) {
            const listaModelos = document.getElementById('listaModelos');
            const htmlModelos = modelos.map(modelo =>
                `<li><a class="dropdown-item filtro-modelo" href="#" data-modelo="${modelo}">${modelo}</a></li>`
            ).join('');
            listaModelos.querySelector('hr').insertAdjacentHTML('afterend', htmlModelos);
        }

        // buscando os dados e atualizando a tela
        async function carregarDadosGestor() {
            try {
                // simulando o fetch (lembrar de tirar isso e ajustar a url qnd conectar na api de vdd)
                const url = `/gestor/${periodoAtual}?modelo=${modeloAtual}`;
                console.log(`buscando dados em: ${url}`);
                // console.log(dadosGestor, dadosGestor, dadosGestor, dadosGestor)
                const resposta = await fetch(url);
                if (!resposta.ok) throw new Error(`deu erro na api: ${resposta.status}`);
                dadosGestor = await resposta.json();

                if (dadosGestor.modelos && dadosGestor.modelos.length > 0) {
                    const listaExistente = document.querySelectorAll('.filtro-modelo').length;
                    if (listaExistente <= 1) {
                        preencherDropdownModelos(dadosGestor.modelos);
                        inicializarFiltroModelo();
                    }
                }

                atualizarKPIs();
                atualizarGraficos();
                atualizarTabela();
                atualizarTextoInfo();
            } catch (erro) {
                console.error('vixe, deu ruim ao carregar dados:', erro);
            }
        }

        function atualizarKPIs() {
            if (!dadosGestor || !dadosGestor.kpis) return;
            const kpis = dadosGestor.kpis;
            const percentualCritico = kpis.totalColetas > 0 ? ((kpis.alertasCriticos / kpis.totalColetas) * 100).toFixed(2) : '0.00';
            const percentualAtencao = kpis.totalColetas > 0 ? ((kpis.alertasAtencao / kpis.totalColetas) * 100).toFixed(2) : '0.00';
            const percentualOk = kpis.totalColetas > 0 ? ((kpis.coletasOk / kpis.totalColetas) * 100).toFixed(2) : '0.00';

            document.getElementById('criticosValue').textContent = `${percentualCritico}%`;
            document.getElementById('atencaoValue').textContent = `${percentualAtencao}%`;
            document.getElementById('operacionaisValue').textContent = `${percentualOk}%`;
            document.querySelector('.uptime-percentage').textContent = `${kpis.uptime}%`;

            // atualizando os textos do card de uptime
            const textosUptime = document.querySelectorAll('.text-black.fw-bold');
            if (textosUptime.length >= 2) {
                textosUptime[0].textContent = kpis.coletasOk || '0';
                textosUptime[1].textContent = kpis.totalColetas || '0';
            }
        }

        // atualizando os textos informativos da tela
        function atualizarTextoInfo() {
            if (!dadosGestor) return;

            // calculando o volume de forma mais esperta dependendo do periodo
            const totalAlertas = dadosGestor.kpis.totalAlertas;
            const periodo = dadosGestor.periodo || 'diario';

            let volumeTexto = '';
            let mediaTexto = '';

            switch (periodo) {
                case 'diario':
                    volumeTexto = `${totalAlertas} alertas hoje`;
                    mediaTexto = `${totalAlertas} por dia`;
                    break;
                case 'semanal':
                    const mediaSemanaDia = (totalAlertas / 7).toFixed(1);
                    volumeTexto = `${totalAlertas} alertas esta semana`;
                    mediaTexto = `${mediaSemanaDia} por dia`;
                    break;
                case 'mensal':
                    const diasMes = new Date(new Date().getFullYear(), new Date().getMonth() + 1, 0).getDate();
                    const mediaMesDia = (totalAlertas / diasMes).toFixed(1);
                    volumeTexto = `${totalAlertas} alertas este mês`;
                    mediaTexto = `${mediaMesDia} por dia`;
                    break;
                case 'anual':
                    const mediaAnoDia = (totalAlertas / 365).toFixed(1);
                    volumeTexto = `${totalAlertas} alertas este ano`;
                    mediaTexto = `${mediaAnoDia} por dia`;
                    break;
            }

            // atualiza "total de alertas" no card de volume
            const totalAlertasEl = document.querySelector('.border-top .fw-semibold.text-dark');
            if (totalAlertasEl) {
                totalAlertasEl.textContent = volumeTexto;
            }

            // atualiza a media
            const mediaAlertasEl = document.querySelectorAll('.border-top .fw-semibold.text-dark')[1];
            if (mediaAlertasEl) {
                mediaAlertasEl.textContent = mediaTexto;
            }

            console.log(`volume calculado: ${volumeTexto} | media: ${mediaTexto}`);
        }

        // aqui a gente chama as funcoes que desenham os graficos
        function atualizarGraficos() {
            if (!dadosGestor) return;
            atualizarGraficoRisco();
            atualizarGraficoAlertas();
            atualizarGraficoFalhas();
            atualizarTabela();
            if (dadosGestor.tendenciaFalhas && dadosGestor.tendenciaFalhas.datasets) {
                atualizarLegendaFalhas(dadosGestor.tendenciaFalhas.datasets);
            }
        }

        // === 1. grafico de risco (barras horizontais) ===
        function atualizarGraficoRisco() {
            const riskEl = document.getElementById('riskChart');
            if (!riskEl) return;

            const areas = dadosGestor.riscoPorArea || [];
            const labels = areas.map(a => a.area);
            const dados = areas.map(a => parseFloat(a.risco));

            // descobre qual area ta mais critica pra gente avisar
            const indiceMaiorRisco = dados.length > 0 ? dados.indexOf(Math.max(...dados)) : -1;
            const areaMaiorRisco = indiceMaiorRisco >= 0 ? labels[indiceMaiorRisco] : 'Nenhuma';
            const percentualMaiorRisco = indiceMaiorRisco >= 0 ? dados[indiceMaiorRisco] : 0;

            console.log(`foco do suporte deve ser: ${areaMaiorRisco} com ${percentualMaiorRisco}% de risco`);

            const backgroundColors = ['#ef4444', '#f97316', '#f59e0b', '#3b82f6', '#10b981'];
            const borderColors = ['#ef4444', '#f97316', '#f59e0b', '#3b82f6', '#10b981'];

            if (chartsInstances.riskChart) {
                chartsInstances.riskChart.destroy();
            }

            const riskCtx = riskEl.getContext('2d');
            chartsInstances.riskChart = new Chart(riskCtx, {
                type: 'bar',
                data: {
                    labels: labels.length > 0 ? labels : ['Sem dados'],
                    datasets: [{
                        label: 'Risco por Área (%)',
                        data: dados.length > 0 ? dados : [0],
                        backgroundColor: backgroundColors.slice(0, Math.max(labels.length, 1)),
                        borderColor: borderColors.slice(0, Math.max(labels.length, 1)),
                        borderWidth: 1,
                        borderRadius: 4,
                        barPercentage: 0.6
                    }]
                },
                options: {
                    indexAxis: 'y', // deixando horizontal
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            beginAtZero: true,
                            max: 100,
                            grid: { display: true, color: '#e5e7eb' },
                            ticks: { color: '#6b7280' }
                        },
                        y: {
                            grid: { display: false },
                            ticks: { color: '#6b7280' }
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            enabled: true,
                            backgroundColor: '#111827',
                            titleColor: '#ffffff',
                            bodyColor: '#ffffff',
                            callbacks: {
                                label: function (context) {
                                    return context.parsed.x.toFixed(2) + '%';
                                }
                            }
                        }
                    }
                }
            });

            atualizarTextoFocoRisco(areaMaiorRisco, percentualMaiorRisco);
        }

        // aqui atualizamos aquele texto abaixo do grafico de risco
        function atualizarTextoFocoRisco(area, risco) {
            const textoEl = document.querySelector('.card-text.text-center.text-muted');
            if (textoEl) {
                textoEl.textContent = `Foco de suporte deve ser na ${area} (${risco.toFixed(2)}% de risco)`;
            }
        }

        // === 2. grafico de alertas (muda dinamicamente) ===
        function atualizarGraficoAlertas() {
            const alertsEl = document.getElementById('alertsChart');
            if (!alertsEl || !dadosGestor) return;

            const periodo = dadosGestor.periodo || 'diario';
            let labels = [];
            let atencaoData = [];
            let criticosData = [];

            // arrumando as labels dependendo do periodo selecionado
            if (periodo === 'diario') {
                labels = Array.from({ length: 24 }, (_, i) => `${String(i).padStart(2, '0')}:00`);
                atencaoData = Array(24).fill(0);
                criticosData = Array(24).fill(0);
            } else if (periodo === 'semanal') {
                labels = ['Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sab', 'Dom'];
                atencaoData = Array(7).fill(0);
                criticosData = Array(7).fill(0);
            } else if (periodo === 'mensal') {
                labels = ['Sem 1', 'Sem 2', 'Sem 3', 'Sem 4', 'Sem 5'];
                atencaoData = Array(5).fill(0);
                criticosData = Array(5).fill(0);
            } else if (periodo === 'anual') {
                labels = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];
                atencaoData = Array(12).fill(0);
                criticosData = Array(12).fill(0);
            }

            // preenchendo com os dados que vieram
            if (dadosGestor.alertasPorPeriodo) {
                dadosGestor.alertasPorPeriodo.forEach(item => {
                    const index = labels.indexOf(item.periodo);
                    if (index >= 0) {
                        atencaoData[index] = item.atencao || 0;
                        criticosData[index] = item.criticos || 0;
                    }
                });
            }

            if (chartsInstances.alertsChart) {
                chartsInstances.alertsChart.destroy();
            }

            chartsInstances.alertsChart = new Chart(alertsEl.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Atenção',
                            data: atencaoData,
                            backgroundColor: '#ffc107',
                            borderRadius: 4
                        },
                        {
                            label: 'Críticos',
                            data: criticosData,
                            backgroundColor: '#dc3545',
                            borderRadius: 4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { grid: { display: false } },
                        y: { beginAtZero: true, grid: { borderDash: [2, 4] } }
                    },
                    plugins: {
                        legend: { position: 'bottom', labels: { boxWidth: 12, usePointStyle: true } }
                    }
                }
            });
        }

        // === 3. grafico de falhas ===
        function atualizarGraficoFalhas() {
            const failuresEl = document.getElementById('failuresChart');
            if (!failuresEl || !dadosGestor.tendenciaFalhas) return;

            if (chartsInstances.failuresChart) chartsInstances.failuresChart.destroy();

            const { meses, datasets } = dadosGestor.tendenciaFalhas;
            const colors = {
                gridColor: 'rgba(0, 0, 0, 0.1)',
                labelColor: 'rgba(0, 0, 0, 0.6)',
                tooltipBgColor: '#FFFFFF',
                tooltipTitleColor: '#333333',
                tooltipBodyColor: '#666666',
                tooltipBorderColor: '#dee2e6',
                pointBorderColor: '#ffffff'
            };

            chartsInstances.failuresChart = new Chart(failuresEl.getContext('2d'), {
                type: 'line',
                data: { labels: meses, datasets: datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: true, position: 'top', labels: { usePointStyle: true } },
                        tooltip: { mode: 'index', intersect: false, backgroundColor: colors.tooltipBgColor, titleColor: colors.tooltipTitleColor, bodyColor: colors.tooltipBodyColor, borderColor: colors.tooltipBorderColor, borderWidth: 1 }
                    },
                    scales: {
                        x: { grid: { display: false }, ticks: { color: colors.labelColor } },
                        y: { beginAtZero: true, grid: { borderDash: [2, 4] }, ticks: { color: colors.labelColor } }
                    },
                    interaction: { intersect: false, mode: 'index' }
                }
            });
        }


        function determinarTendencia(dados) {
            if (dados.length < 2) return 'Estável';
            const ultimoTercoDados = dados.slice(Math.floor(dados.length * 2 / 3));
            const primeiroTercoDados = dados.slice(0, Math.floor(dados.length / 3));
            const mediaUltimo = ultimoTercoDados.reduce((a, b) => a + b, 0) / ultimoTercoDados.length;
            const mediaPrimeiro = primeiroTercoDados.reduce((a, b) => a + b, 0) / primeiroTercoDados.length;
            const diferencaPercentual = ((mediaUltimo - mediaPrimeiro) / mediaPrimeiro) * 100;
            if (diferencaPercentual > 10) return 'Piorando ';
            if (diferencaPercentual < -10) return 'Melhorando ';
            return 'Estável';
        }

        function atualizarLegendaFalhas(datasets) {
            const legendaContainer = document.getElementById('legendaFalhas');
            if (!legendaContainer) return;
            legendaContainer.innerHTML = '';
            datasets.forEach((dataset) => {
                const div = document.createElement('div');
                div.className = 'd-flex align-items-center';
                const tendencia = determinarTendencia(dataset.data);
                const statusClass = tendencia.includes('Piorando') ? 'text-warning' : tendencia.includes('Melhorando') ? 'text-success' : 'text-secondary';
                div.innerHTML = `<span class="legend-dot me-2" style="background-color: ${dataset.borderColor}; width: 12px; height: 12px; border-radius: 50%;"></span><span class="text-body-secondary me-1">${dataset.label.split('(')[0].trim()}</span><span class="${statusClass} fw-medium" style="font-size: 0.85rem;">(${tendencia})</span>`;
                legendaContainer.appendChild(div);
            });
        }

        // atualizando a tabela e os cards de status
        function atualizarTabela() {
            if (!dadosGestor || !dadosGestor.uptimeRealPorHospital) {
                console.error('dados de hospital nao disponiveis');
                return;
            }

            const tbody = document.querySelector('table tbody');
            if (!tbody) return;

            tbody.innerHTML = '';

            const hospitais = dadosGestor.uptimeRealPorHospital;

            console.log('hospitais pra montar a tabela:', hospitais);

            // montando a tabela
            hospitais.forEach(hospital => {
                const tr = document.createElement('tr');
                const classUptime = parseFloat(hospital.uptime) >= 90 ? 'zephyrus-text-success' : 'text-warning';

                tr.innerHTML = `
                    <td class="fw-medium">${hospital.nomeHospital}</td>
                    <td class="text-muted">${hospital.ventiladores}</td>
                    <td class="fw-semibold zephyrus-text-success">${hospital.operacionais}</td>
                    <td class="fw-semibold text-warning">${hospital.atencao}</td>
                    <td class="fw-semibold text-danger">${hospital.criticos}</td>
                    <td class="fw-semibold ${classUptime}">${hospital.uptime}%</td>
                `;
                tbody.appendChild(tr);
            });

            // acha o melhor e o pior pra atualizar os cards
            if (hospitais.length > 0) {
                const melhorHospital = hospitais[0];
                const piorHospital = hospitais[hospitais.length - 1];

                console.log('melhor:', melhorHospital);
                console.log('pior:', piorHospital);

                atualizarCardsMelhorPior(melhorHospital, piorHospital);
            }
        }

        // atualiza os cards de destaque de melhor e pior performance
        function atualizarCardsMelhorPior(melhor, pior) {
            const cardPiorContainer = document.querySelector('.col-md-6:has(.border-danger-subtle)');
            const cardMelhorContainer = document.querySelector('.col-md-6:has(.border-success-subtle)');

            if (cardPiorContainer) {
                cardPiorContainer.innerHTML = `
                    <div class="card h-100 border-danger-subtle bg-danger-subtle bg-opacity-10">
                        <div class="card-body d-flex align-items-center p-3">
                            <div class="kpi-card-icon bg-danger-subtle me-3">
                                <span class="material-icons-outlined text-danger">error_outline</span>
                            </div>
                            <div>
                                <p class="mb-0 small text-danger fw-medium">Pior Experiência</p>
                                <p class="h5 mb-1 fw-bold text-dark">${pior.nomeHospital}</p>
                                <p class="mb-0 text-danger fw-semibold">${pior.criticos} críticos (${pior.uptime}% uptime)</p>
                            </div>
                        </div>
                    </div>
                `;
            }

            if (cardMelhorContainer) {
                cardMelhorContainer.innerHTML = `
                    <div class="card h-100 border-success-subtle bg-success-subtle bg-opacity-10">
                        <div class="card-body d-flex align-items-center p-3">
                            <div class="kpi-card-icon bg-success-subtle me-3">
                                <span class="material-icons-outlined zephyrus-text-success">apartment</span>
                            </div>
                            <div>
                                <p class="mb-0 small zephyrus-text-success fw-medium">Melhor Performance</p>
                                <p class="h5 mb-1 fw-bold text-dark">${melhor.nomeHospital}</p>
                                <p class="mb-0 zephyrus-text-success fw-semibold">${melhor.uptime}% operacional</p>
                            </div>
                        </div>
                    </div>
                `;
            }
        }
        window.addEventListener('load', () => {
            Chart.defaults.font.family = "'Segoe UI', 'Roboto', 'Helvetica Neue', 'Arial', sans-serif";
            inicializarFiltro();
            atualizarIndicadorData(); // Inicializar com data padrão
            carregarDadosGestor();
            setInterval(carregarDadosGestor, 300000);
            const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl, {
                    trigger: 'hover',
                    delay: { show: 200, hide: 100 }
                });
            });
        });
    </script>
</body>

</html>